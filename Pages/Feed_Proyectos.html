<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIP - Proyecto Individual</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="/Feed_Proyectos.css">
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <header class="header">
      <img src="/img/logo.png" alt="SIP Logo" class="logo-header">
      <nav class="nav-header">
        <a href="/feed-proyectos"><i class="fa-solid fa-layer-group"></i> Proyectos</a>
        <a href="#" id="notificaciones-btn"><i class="fa-regular fa-bell"></i> Notificaciones</a>
        <div class="user-info" id="perfil-btn">
          <span class="user-avatar">D</span>
          <span class="user-name">Daniela</span>
        </div>
      </nav>
      <!-- Notificaciones Popover -->
    <div id="notificaciones-popover" class="notificaciones-popover">
      <div class="notificaciones-arrow"></div>
      <h3>Notificaciones</h3>
      <div class="notificacion-item">
        <span class="notif-avatar">A</span>
        <div>
          <strong>Respondió tu publicación</strong>
          <div class="notif-text">Te dare varias ideas para tu proyecto...</div>
        </div>
      </div>
      <div class="notificacion-item">
        <span class="notif-avatar">J</span>
        <div>
          <strong>Respondió tu publicación</strong>
          <div class="notif-text">Te dare varias ideas para tu proyecto...</div>
        </div>
      </div>
      <div class="notificacion-item">
        <span class="notif-avatar">D</span>
        <div>
          <strong>Respondió tu respuesta</strong>
          <div class="notif-text">Muchas gracias me sirvió mucho, sig...</div>
        </div>
      </div>
    </div>
    </header>

    <!-- MODAL SUBIR PROYECTO -->
    <div id="modal-subir-proyecto" class="modal-publicacion" style="display:none;">
      <div class="modal-content">
        <h2>Subir Proyecto</h2>
        <form id="form-subir-proyecto" enctype="multipart/form-data">
          <input type="hidden" name="user_id" id="user_id">
          
          <input type="text" name="titulo" placeholder="Título..." required />
          <textarea name="descripcion" placeholder="Ingrese la descripción..." required></textarea>
          
        <!-- SELECT DE PROGRAMA CORREGIDO -->
<select name="programa" id="select-programa" required style="width:100%; padding:12px; margin-bottom:18px; border:1.5px solid #3ec9a7; border-radius:12px;">
  <option value="">Selecciona tu programa</option>
  <option value="Tecnólogo en Análisis y Desarrollo de Software">Tecnólogo en Análisis y Desarrollo de Software</option>
  <option value="Tecnólogo en Animación Digital">Tecnólogo en Animación Digital</option>
  <option value="Tecnólogo en Automatización de Sistemas Mecatrónicos">Tecnólogo en Automatización de Sistemas Mecatrónicos</option>
  <option value="Tecnólogo en Desarrollo de Sistemas Electrónicos Industriales">Tecnólogo en Desarrollo de Sistemas Electrónicos Industriales</option>
  <option value="Tecnólogo en Desarrollo Multimedia y Web">Tecnólogo en Desarrollo Multimedia y Web</option>
  <option value="Tecnólogo en Electricidad Industrial">Tecnólogo en Electricidad Industrial</option>
  <option value="Tecnólogo en Gestión de la Producción Industrial">Tecnólogo en Gestión de la Producción Industrial</option>
  <option value="Tecnólogo en Gestión de Proyectos de Desarrollo Económico y Social">Tecnólogo en Gestión de Proyectos de Desarrollo Económico y Social</option>
  <option value="Tecnólogo en Gestión de Redes de Datos">Tecnólogo en Gestión de Redes de Datos</option>
  <option value="Tecnólogo en Gestión eficiente de la energía">Tecnólogo en Gestión eficiente de la energía</option>
  <option value="Tecnólogo en Implementación de Infraestructura de Tecnologías de la Información y las Comunicaciones">Tecnólogo en Implementación de Infraestructura de Tecnologías de la Información y las Comunicaciones</option>
  <option value="Tecnólogo en Implementación y Mantenimiento de Sistemas de Instrumentación y Control de Procesos Industriales">Tecnólogo en Implementación y Mantenimiento de Sistemas de Instrumentación y Control de Procesos Industriales</option>
  <option value="Tecnólogo en Supervisión de Redes de Distribución de Energía Eléctrica">Tecnólogo en Supervisión de Redes de Distribución de Energía Eléctrica</option>
  <option value="Técnico en Instalación de Redes Internas de Telecomunicaciones">Técnico en Instalación de Redes Internas de Telecomunicaciones</option>
  <option value="Técnico en Instalación de Sistemas Eléctricos Residenciales y Comerciales">Técnico en Instalación de Sistemas Eléctricos Residenciales y Comerciales</option>
  <option value="Técnico en Instrumentación Industrial">Técnico en Instrumentación Industrial</option>
  <option value="Técnico en Integración de Contenidos Digitales">Técnico en Integración de Contenidos Digitales</option>
  <option value="Técnico en Mantenimiento e Instalación de Sistemas Solares Fotovoltaicos">Técnico en Mantenimiento e Instalación de Sistemas Solares Fotovoltaicos</option>
  <option value="Técnico en Asistencia Administrativa">Técnico en Asistencia Administrativa</option>
  <option value="Técnico en Atención Integral al Cliente">Técnico en Atención Integral al Cliente</option>
  <option value="Técnico en Control de la Seguridad Digital">Técnico en Control de la Seguridad Digital</option>
  <option value="Técnico en Dibujo Mecánico">Técnico en Dibujo Mecánico</option>
  <option value="Técnico en Electricista Industrial">Técnico en Electricista Industrial</option>
  <option value="Técnico en Mantenimiento y Ensamble de Equipos Electrónicos">Técnico en Mantenimiento y Ensamble de Equipos Electrónicos</option>
  <option value="Técnico en Modelado 3D para la Industria">Técnico en Modelado 3D para la Industria</option>
  <option value="Técnico en Monitoreo Ambiental">Técnico en Monitoreo Ambiental</option>
  <option value="Técnico en Montaje y Mantenimiento de Redes Aéreas de Distribución de Energía Eléctrica">Técnico en Montaje y Mantenimiento de Redes Aéreas de Distribución de Energía Eléctrica</option>
  <option value="Técnico en Procesos de Manufactura">Técnico en Procesos de Manufactura</option>
  <option value="Técnico en Servicios y Operaciones Microfinancieras">Técnico en Servicios y Operaciones Microfinancieras</option>
  <option value="Técnico en Sistemas teleinformáticos">Técnico en Sistemas teleinformáticos</option>
  <option value="Técnico en Programación de Aplicaciones para Dispositivos Móviles">Técnico en Programación de Aplicaciones para Dispositivos Móviles</option>
  <option value="Técnico en Programación de Software">Técnico en Programación de Software</option>
  <option value="Técnico en Programación para Aplicaciones">Técnico en Programación para Aplicaciones</option>
</select>
        

          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">Agrega maximo 5 imagenes...</div>
          <input type="file" name="imagenes" accept="image/*" multiple style="margin-bottom:10px;">
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">
            Agrega documentación (PDF)...
          </div>
          <input type="file" name="documento_pdf" id="pdf-doc" accept="application/pdf" style="display:none;">
          <label for="pdf-doc" class="pdf-label">Seleccionar PDF</label>
          <span id="pdf-name"></span>
          <div id="pdf-preview" style="margin-bottom:10px;"></div>
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">Agrega enlace de Github (Codigo)...</div>
          <input type="url" name="github_url" placeholder="https://github.com/usuario/proyecto" />
          
          <div class="modal-btns">
            <button type="submit" id="btn-publicar" class="btn-modal">Publicar</button>
            <button type="button" id="btn-cancelar" class="btn-modal cancelar">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL EDITAR PROYECTO -->
    <div id="modal-editar-proyecto" class="modal-publicacion" style="display:none;">
      <div class="modal-content">
        <h2>Editar Proyecto</h2>
        <form id="form-editar-proyecto" enctype="multipart/form-data">
          <input type="hidden" name="user_id" id="edit_user_id">
          <input type="hidden" name="proyecto_id" id="edit_proyecto_id">
          
          <input type="text" name="titulo" id="edit_titulo" placeholder="Título..." required />
          <textarea name="descripcion" id="edit_descripcion" placeholder="Ingrese la descripción..." required></textarea>
          
          <!-- SELECT DE PROGRAMA -->
          <select name="programa" id="edit_programa" required style="width:100%; padding:12px; margin-bottom:18px; border:1.5px solid #3ec9a7; border-radius:12px;">
            <option value="">Selecciona tu programa</option>
  <option value="Tecnólogo en Análisis y Desarrollo de Software">Tecnólogo en Análisis y Desarrollo de Software</option>
  <option value="Tecnólogo en Animación Digital">Tecnólogo en Animación Digital</option>
  <option value="Tecnólogo en Automatización de Sistemas Mecatrónicos">Tecnólogo en Automatización de Sistemas Mecatrónicos</option>
  <option value="Tecnólogo en Desarrollo de Sistemas Electrónicos Industriales">Tecnólogo en Desarrollo de Sistemas Electrónicos Industriales</option>
  <option value="Tecnólogo en Desarrollo Multimedia y Web">Tecnólogo en Desarrollo Multimedia y Web</option>
  <option value="Tecnólogo en Electricidad Industrial">Tecnólogo en Electricidad Industrial</option>
  <option value="Tecnólogo en Gestión de la Producción Industrial">Tecnólogo en Gestión de la Producción Industrial</option>
  <option value="Tecnólogo en Gestión de Proyectos de Desarrollo Económico y Social">Tecnólogo en Gestión de Proyectos de Desarrollo Económico y Social</option>
  <option value="Tecnólogo en Gestión de Redes de Datos">Tecnólogo en Gestión de Redes de Datos</option>
  <option value="Tecnólogo en Gestión eficiente de la energía">Tecnólogo en Gestión eficiente de la energía</option>
  <option value="Tecnólogo en Implementación de Infraestructura de Tecnologías de la Información y las Comunicaciones">Tecnólogo en Implementación de Infraestructura de Tecnologías de la Información y las Comunicaciones</option>
  <option value="Tecnólogo en Implementación y Mantenimiento de Sistemas de Instrumentación y Control de Procesos Industriales">Tecnólogo en Implementación y Mantenimiento de Sistemas de Instrumentación y Control de Procesos Industriales</option>
  <option value="Tecnólogo en Supervisión de Redes de Distribución de Energía Eléctrica">Tecnólogo en Supervisión de Redes de Distribución de Energía Eléctrica</option>
  <option value="Técnico en Instalación de Redes Internas de Telecomunicaciones">Técnico en Instalación de Redes Internas de Telecomunicaciones</option>
  <option value="Técnico en Instalación de Sistemas Eléctricos Residenciales y Comerciales">Técnico en Instalación de Sistemas Eléctricos Residenciales y Comerciales</option>
  <option value="Técnico en Instrumentación Industrial">Técnico en Instrumentación Industrial</option>
  <option value="Técnico en Integración de Contenidos Digitales">Técnico en Integración de Contenidos Digitales</option>
  <option value="Técnico en Mantenimiento e Instalación de Sistemas Solares Fotovoltaicos">Técnico en Mantenimiento e Instalación de Sistemas Solares Fotovoltaicos</option>
  <option value="Técnico en Asistencia Administrativa">Técnico en Asistencia Administrativa</option>
  <option value="Técnico en Atención Integral al Cliente">Técnico en Atención Integral al Cliente</option>
  <option value="Técnico en Control de la Seguridad Digital">Técnico en Control de la Seguridad Digital</option>
  <option value="Técnico en Dibujo Mecánico">Técnico en Dibujo Mecánico</option>
  <option value="Técnico en Electricista Industrial">Técnico en Electricista Industrial</option>
  <option value="Técnico en Mantenimiento y Ensamble de Equipos Electrónicos">Técnico en Mantenimiento y Ensamble de Equipos Electrónicos</option>
  <option value="Técnico en Modelado 3D para la Industria">Técnico en Modelado 3D para la Industria</option>
  <option value="Técnico en Monitoreo Ambiental">Técnico en Monitoreo Ambiental</option>
  <option value="Técnico en Montaje y Mantenimiento de Redes Aéreas de Distribución de Energía Eléctrica">Técnico en Montaje y Mantenimiento de Redes Aéreas de Distribución de Energía Eléctrica</option>
  <option value="Técnico en Procesos de Manufactura">Técnico en Procesos de Manufactura</option>
  <option value="Técnico en Servicios y Operaciones Microfinancieras">Técnico en Servicios y Operaciones Microfinancieras</option>
  <option value="Técnico en Sistemas teleinformáticos">Técnico en Sistemas teleinformáticos</option>
  <option value="Técnico en Programación de Aplicaciones para Dispositivos Móviles">Técnico en Programación de Aplicaciones para Dispositivos Móviles</option>
  <option value="Técnico en Programación de Software">Técnico en Programación de Software</option>
  <option value="Técnico en Programación para Aplicaciones">Técnico en Programación para Aplicaciones</option>
</select>
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">Agrega maximo 5 imagenes...</div>
          <input type="file" name="imagenes" id="edit_imagenes" accept="image/*" multiple style="margin-bottom:10px;">
          <div id="edit_imagenes_actuales" style="margin-bottom:10px;"></div>
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">
            Agrega documentación (PDF)...
          </div>
          <input type="file" name="documento_pdf" id="edit_pdf-doc" accept="application/pdf" style="display:none;">
          <label for="edit_pdf-doc" class="pdf-label">Seleccionar PDF</label>
          <span id="edit_pdf-name"></span>
          <div id="edit_pdf-preview" style="margin-bottom:10px;"></div>
          <div id="edit_pdf_actual" style="margin-bottom:10px;"></div>
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">Agrega enlace de Github (Codigo)...</div>
          <input type="url" name="github_url" id="edit_github_url" placeholder="https://github.com/usuario/proyecto" />
          
          <div class="modal-btns">
            <button type="submit" id="btn-actualizar" class="btn-modal">Actualizar</button>
            <button type="button" id="btn-cancelar-edicion" class="btn-modal cancelar">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Menú Popover de Usuario -->
    <div id="popover-menu" class="popover-menu">
      <div class="popover-arrow"></div>
      <div class="popover-content">
        <ul class="popover-list">
          <li>
            <span class="icon">
              <i class="fa-regular fa-user"></i>
            </span>
            <span>Perfil</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-solid fa-gear"></i>
            </span>
            <span>Configuración</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-regular fa-star"></i>
            </span>
            <span>Favoritos</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-regular fa-circle-question"></i>
            </span>
            <span>Ayuda</span>
          </li>
        </ul>
        <form action="/api/logout" method="POST" id="logoutForm">
          <input type="hidden" name="user_id" id="user_id">>
          <button type="submit" class="logout-btn" id="logoutBtn">Cerrar sesión</button>
        </form>
      </div>
    </div>

    <main class="proyectos-main">
      <!-- Panel de filtros -->
      <aside class="filtros">
        <button class="btn-subir" type="button">Subir proyecto</button>
        <form class="filtros-form" action="/api/proyectos/buscar" method="GET" id="form-filtros">
          <input type="text" name="keyword" placeholder="Buscar por palabra clave...">
          <select name="programa">
            <option value="">Todos los programas</option>
            <option value="software">Desarrollo de Software</option>
            <option value="redes">Redes y Telecomunicaciones</option>
          </select>
          <select name="rol">
            <option value="">Todos los roles</option>
            <option value="aprendiz">Aprendiz</option>
            <option value="egresado">Egresado</option>
            <option value="instructor">Instructor</option>
          </select>
          <input type="date" name="fecha" placeholder="dd/mm/aaaa">
          <button type="submit" style="display:none;">Buscar</button>
        </form>
        <button class="btn-limpiar" type="button">Limpiar Filtros</button>
      </aside>

      <!-- Lista de proyectos -->
      <section class="proyectos-lista" id="proyectos-lista">
        <!-- Los proyectos se cargarán dinámicamente aquí -->
      </section>
    </main>

    

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <hr class="footer-line">
        <div class="footer-icons">
          <i class="fab fa-twitter"></i>
          <i class="fab fa-facebook"></i>
          <i class="fab fa-instagram"></i>
        </div>
        <hr class="footer-line">
      </div>
      <div class="footer-text">
        Copyright © 2025 SENA INTERACTIVE PORTAL
      </div>
      <div class="footer-links">
        <span>Información legal</span>
        <span>Política de privacidad</span>
      </div>
    </footer>
  </div>

  <script>
// ==================== VARIABLES GLOBALES ====================
let usuarioActual = null;
let token = null;
let menuAbierto = null;
let currentMenu = null;

// ==================== INICIALIZACIÓN ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Iniciando aplicación de proyectos...');
    
    // Verificar autenticación
    verificarAutenticacion();
    
    // Configurar event listeners
    configurarEventListeners();
    
    // Cargar proyectos
    cargarProyectos();
});

// ==================== AUTENTICACIÓN ====================
function verificarAutenticacion() {
    token = localStorage.getItem('token');
    const usuarioStr = localStorage.getItem('usuario');
    
    if (!token || !usuarioStr) {
        console.log('❌ No hay sesión activa, redirigiendo al login...');
        alert('Debes iniciar sesión para acceder a esta página');
        window.location.href = '/login';
        return;
    }
    
    try {
        usuarioActual = JSON.parse(usuarioStr);
        console.log('✅ Usuario autenticado:', usuarioActual);
        
        // ✅ ACTUALIZAR ID DE USUARIO EN FORMULARIOS
        document.getElementById('user_id').value = usuarioActual.id;
        document.getElementById('edit_user_id').value = usuarioActual.id;
        
        // Actualizar header con info del usuario
        actualizarHeaderUsuario();
        
    } catch (error) {
        console.error('Error al parsear usuario:', error);
        alert('Error en la sesión. Por favor inicia sesión nuevamente.');
        window.location.href = '/login';
    }
}

function actualizarHeaderUsuario() {
    const userNameElement = document.querySelector('.user-name');
    const userAvatarElement = document.querySelector('.user-avatar');
    
    if (userNameElement && usuarioActual) {
        userNameElement.textContent = usuarioActual.nombre;
    }
    
    if (userAvatarElement && usuarioActual) {
        userAvatarElement.textContent = usuarioActual.nombre.charAt(0).toUpperCase();
    }
}

// ==================== CONFIGURACIÓN DEL MENÚ DE PERFIL ====================
function configurarMenuPerfil() {
    const perfilBtn = document.getElementById('perfil-btn');
    const popoverMenu = document.getElementById('popover-menu');

    if (perfilBtn && popoverMenu) {
        // Remover event listeners anteriores para evitar duplicados
        perfilBtn.replaceWith(perfilBtn.cloneNode(true));
        const nuevoPerfilBtn = document.getElementById('perfil-btn');
        
        nuevoPerfilBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isVisible = popoverMenu.style.display === 'block';
            
            // Cerrar notificaciones si están abiertas
            document.getElementById('notificaciones-popover').style.display = 'none';
            
            popoverMenu.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                const rect = nuevoPerfilBtn.getBoundingClientRect();
                popoverMenu.style.position = 'fixed';
                popoverMenu.style.top = (rect.bottom + window.scrollY + 10) + 'px';
                popoverMenu.style.left = (rect.left + window.scrollX - 100) + 'px';
                popoverMenu.style.zIndex = '1000';
            }
        });

        // Configurar items del menú
        document.querySelectorAll('.popover-list li').forEach((li, idx) => {
            li.addEventListener('click', () => {
                switch(idx) {
                    case 0: 
                        window.location.href = '/perfil';
                        break;
                    case 1: 
                        window.location.href = '/configuracion';
                        break;
                    case 2: 
                        window.location.href = '/favoritos';
                        break;
                    case 3: 
                        window.location.href = '/ayuda';
                        break;
                }
                popoverMenu.style.display = 'none';
            });
        });

        // Cerrar menú al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (popoverMenu && !popoverMenu.contains(e.target) && e.target !== nuevoPerfilBtn) {
                popoverMenu.style.display = 'none';
            }
        });
    }
}

// ==================== EVENT LISTENERS ====================
function configurarEventListeners() {
    // Menú de perfil - PRIMERO Y MÁS IMPORTANTE
    configurarMenuPerfil();
    
    // Logout
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cerrarSesion();
        });
    }
    
    // Modal subir proyecto
    const btnSubir = document.querySelector('.btn-subir');
    if (btnSubir) {
        btnSubir.addEventListener('click', function() {
            if (!usuarioActual) {
                alert('Debes iniciar sesión para subir proyectos');
                window.location.href = '/login';
                return;
            }
            document.getElementById('modal-subir-proyecto').style.display = 'flex';
        });
    }
    
    // Botones de cancelar modales
    const btnCancelar = document.getElementById('btn-cancelar');
    if (btnCancelar) {
        btnCancelar.addEventListener('click', function() {
            document.getElementById('modal-subir-proyecto').style.display = 'none';
        });
    }
    
    const btnCancelarEdicion = document.getElementById('btn-cancelar-edicion');
    if (btnCancelarEdicion) {
        btnCancelarEdicion.addEventListener('click', function() {
            document.getElementById('modal-editar-proyecto').style.display = 'none';
        });
    }
    
    // Cerrar modales al hacer clic fuera
    document.getElementById('modal-subir-proyecto').addEventListener('click', function(e) {
        if (e.target === this) this.style.display = 'none';
    });
    
    document.getElementById('modal-editar-proyecto').addEventListener('click', function(e) {
        if (e.target === this) this.style.display = 'none';
    });
    
    // Formulario de subir proyecto
    document.getElementById('form-subir-proyecto').addEventListener('submit', subirProyecto);
    
    // Formulario de editar proyecto
    document.getElementById('form-editar-proyecto').addEventListener('submit', actualizarProyecto);
    
    // PDF personalizado
    configurarPDFInputs();
    
    // Notificaciones
    configurarNotificaciones();
    
    // Botón limpiar filtros
    const btnLimpiar = document.querySelector('.btn-limpiar');
    if (btnLimpiar) {
        btnLimpiar.addEventListener('click', limpiarFiltros);
    }
    
    // Botones de estrella (favorito)
    aplicarEventListenersFavoritos();
}

// ==================== CERRAR SESIÓN ====================
function cerrarSesion() {
    console.log('👋 Cerrando sesión...');
    localStorage.removeItem('token');
    localStorage.removeItem('usuario');
    alert('Sesión cerrada exitosamente');
    window.location.href = '/login';
}

// ==================== FUNCIONES DE TIEMPO ====================
function verificarTiempoEdicion(fechaCreacion) {
    try {
        const ahora = Date.now();
        const fechaCreacionTime = new Date(fechaCreacion).getTime();
        const diferenciaMinutos = (ahora - fechaCreacionTime) / 60000;
        
        console.log(`⏱️ Verificando tiempo: ${diferenciaMinutos.toFixed(2)} minutos transcurridos`);
        
        return diferenciaMinutos <= 15;
    } catch (error) {
        console.error('Error al verificar tiempo:', error);
        return false;
    }
}

function calcularMinutosRestantes(fechaCreacion) {
    try {
        const ahora = Date.now();
        const fechaCreacionTime = new Date(fechaCreacion).getTime();
        const diferenciaMinutos = (ahora - fechaCreacionTime) / 60000;
        
        return Math.max(0, Math.floor(15 - diferenciaMinutos));
    } catch (error) {
        return 0;
    }
}

let intervaloActualizacion = null;

function iniciarActualizacionTiempo() {
    if (intervaloActualizacion) {
        clearInterval(intervaloActualizacion);
    }
    
    intervaloActualizacion = setInterval(() => {
        document.querySelectorAll('.proyecto-card').forEach(card => {
            const fechaCreacion = card.getAttribute('data-fecha-creacion');
            if (!fechaCreacion) return;
            
            const minutosRestantes = calcularMinutosRestantes(fechaCreacion);
            const fechaSpan = card.querySelector('.proyecto-fecha');
            
            if (fechaSpan) {
                const fechaBase = fechaSpan.textContent.replace(/⏱️.*$/g, '').trim();
                
                if (minutosRestantes > 0) {
                    fechaSpan.innerHTML = `${fechaBase}<span style="color:#28a745; font-size:12px; margin-left:8px;">⏱️ ${minutosRestantes} min para editar</span>`;
                } else {
                    fechaSpan.innerHTML = `${fechaBase}<span style="color:#dc3545; font-size:12px; margin-left:8px;">⏱️ Tiempo expirado</span>`;
                    
                    const menu = card.querySelector('.menu-desplegable');
                    if (menu) {
                        const btnEditar = menu.querySelector('.editar');
                        if (btnEditar && !btnEditar.disabled) {
                            btnEditar.disabled = true;
                            btnEditar.style.opacity = '0.5';
                            btnEditar.style.cursor = 'not-allowed';
                            btnEditar.title = 'Tiempo de edición expirado';
                            btnEditar.innerHTML = '<i class="fas fa-edit"></i> Editar (Expirado)';
                        }
                    }
                }
            }
        });
    }, 60000);
    
    console.log('⏱️ Actualizador de tiempo iniciado');
}

// ==================== SUBIR PROYECTO ====================
async function subirProyecto(e) {
    e.preventDefault();
    
    if (!usuarioActual || !token) {
        alert('❌ Debes iniciar sesión para subir proyectos');
        window.location.href = '/login';
        return;
    }
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById('btn-publicar');
    
    formData.set('user_id', usuarioActual.id);
    
    console.log('📤 Enviando proyecto con user_id:', usuarioActual.id);
    
    const titulo = formData.get('titulo');
    const descripcion = formData.get('descripcion');
    const programa = formData.get('programa');
    
    if (!titulo || !descripcion || !programa) {
        alert('❌ Por favor completa todos los campos requeridos');
        return;
    }
    
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('/api/proyectos/crear', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        console.log('📥 Respuesta del servidor:', data);
        
        if (data.success) {
            alert('✅ Proyecto publicado exitosamente!');
            
            document.getElementById('modal-subir-proyecto').style.display = 'none';
            
            this.reset();
            document.getElementById('pdf-name').textContent = '';
            document.getElementById('pdf-preview').innerHTML = '';
            
            await cargarProyectos();
        } else {
            throw new Error(data.message || 'Error al publicar proyecto');
        }
        
    } catch (error) {
        console.error('❌ Error al publicar proyecto:', error);
        alert('❌ Error al publicar proyecto: ' + error.message);
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// ==================== CARGAR PROYECTOS ====================
async function cargarProyectos() {
    try {
        console.log('📖 Cargando proyectos...');
        
        const response = await fetch('/api/proyectos');
        
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📚 Proyectos cargados:', data);
        
        if (data.success) {
            mostrarProyectos(data.proyectos);
        } else {
            throw new Error(data.message || 'Error al cargar proyectos');
        }
    } catch (error) {
        console.error('❌ Error al cargar proyectos:', error);
        document.getElementById('proyectos-lista').innerHTML = `
            <div class="proyecto-card" style="text-align: center; padding: 40px;">
                <h3>Error al cargar proyectos</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

// ==================== MOSTRAR PROYECTOS ====================
function mostrarProyectos(proyectos) {
    const contenedor = document.getElementById('proyectos-lista');
    
    if (!proyectos || proyectos.length === 0) {
        contenedor.innerHTML = `
            <div class="proyecto-card" style="text-align: center; padding: 40px;">
                <h3>No hay proyectos publicados aún</h3>
                <p>¡Sé el primero en compartir tu proyecto!</p>
            </div>
        `;
        return;
    }

    contenedor.innerHTML = proyectos.map((proyecto) => {
        const esAutor = usuarioActual && usuarioActual.id === proyecto.ID_usuario;
        const puedeEditar = esAutor && verificarTiempoEdicion(proyecto.fecha_creacion);
        const minutosRestantes = calcularMinutosRestantes(proyecto.fecha_creacion);
        
        let indicadorTiempo = '';
        if (esAutor && minutosRestantes > 0) {
            indicadorTiempo = `<span style="color:#28a745; font-size:12px; margin-left:8px;">⏱️ ${minutosRestantes} min para editar</span>`;
        } else if (esAutor && minutosRestantes === 0) {
            indicadorTiempo = `<span style="color:#dc3545; font-size:12px; margin-left:8px;">⏱️ Tiempo expirado</span>`;
        }
        
        return `
            <div class="proyecto-card" data-proyecto-id="${proyecto.ID_proyecto}" data-fecha-creacion="${proyecto.fecha_creacion}">
                <div class="proyecto-header">
                    <span class="proyecto-titulo">${proyecto.nombre || 'Sin título'}</span>
                    <span class="proyecto-etiqueta egresado">${proyecto.rol_autor || 'Egresado'}</span>
                    <span class="proyecto-fecha">${formatearFecha(proyecto.fecha_creacion)}${indicadorTiempo}</span>
                    
                    ${esAutor ? `
                    <div class="proyecto-acciones">
                        <button class="menu-tres-puntos" onclick="toggleProyectoMenu(${proyecto.ID_proyecto}, event)">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        
                        <div class="menu-desplegable" id="menu-${proyecto.ID_proyecto}">
                            ${puedeEditar ? `
                                <button class="menu-item editar" onclick="editarProyecto(${proyecto.ID_proyecto})">
                                    <i class="fas fa-edit"></i>
                                    Editar
                                </button>
                            ` : `
                                <button class="menu-item editar" disabled style="opacity:0.5; cursor:not-allowed;" title="Tiempo de edición expirado (15 min)">
                                    <i class="fas fa-edit"></i>
                                    Editar (Expirado)
                                </button>
                            `}
                            <button class="menu-item eliminar" onclick="eliminarProyecto(${proyecto.ID_proyecto})">
                                <i class="fas fa-trash"></i>
                                Eliminar
                            </button>
                        </div>
                        
                        <button class="proyecto-fav"><i class="fa-regular fa-star"></i></button>
                    </div>
                    ` : `
                    <button class="proyecto-fav"><i class="fa-regular fa-star"></i></button>
                    `}
                </div>
                
                <div class="proyecto-autor">${proyecto.autor_completo || (proyecto.nombre_autor + ' ' + proyecto.apellido_autor) || 'Autor no disponible'}</div>
                <div class="proyecto-carrera">${proyecto.programa_autor || 'Tecnología en Desarrollo de Software'}</div>
                <div class="proyecto-desc">${proyecto.descripcion || 'Sin descripción'}</div>
                
                ${proyecto.github_url ? `
                    <div class="proyecto-github" style="margin: 8px 0;">
                        <a href="${proyecto.github_url}" target="_blank" style="color: #10b981; text-decoration: none; font-weight: 600;">
                            <i class="fab fa-github"></i> Ver código en GitHub
                        </a>
                    </div>
                ` : ''}
                
                ${proyecto.documento_pdf ? `
                    <div class="proyecto-pdf" style="margin: 8px 0;">
                        <a href="${proyecto.documento_pdf}" target="_blank" style="color: #e53e3e; text-decoration: none; font-weight: 600;">
                            <i class="far fa-file-pdf"></i> Ver documentación PDF
                        </a>
                    </div>
                ` : ''}
                
                <div class="proyecto-footer">
                    <div class="proyecto-comentarios-container" id="comentarios-${proyecto.ID_proyecto}">
                        <span class="proyecto-comentarios" style="cursor:pointer; font-weight:600;" 
                              onclick="toggleComentariosProyecto(${proyecto.ID_proyecto})">
                            Ver comentarios
                        </span>
                        <div class="mini-comentarios" id="mini-comentarios-${proyecto.ID_proyecto}" style="display:none;">
                            <!-- Los comentarios se cargarán aquí -->
                        </div>
                    </div>
                    <a href="/Detalles_Proyecto.html?id=${proyecto.ID_proyecto}" class="btn-abrir">Abrir</a>
                </div>
            </div>
        `;
    }).join('');
    
    aplicarEventListenersFavoritos();
    iniciarActualizacionTiempo();
    
    // Cargar el contador de comentarios para cada proyecto
    proyectos.forEach(proyecto => {
        cargarComentariosProyecto(proyecto.ID_proyecto);
    });
}

// ==================== EDITAR PROYECTO ====================
async function editarProyecto(proyectoId) {
    try {
        console.log('✏️ Editando proyecto:', proyectoId);
        
        const response = await fetch(`/api/proyectos/${proyectoId}`);
        const data = await response.json();
        
        if (data.success && data.proyecto) {
            const proyecto = data.proyecto;
            
            if (proyecto.ID_usuario !== usuarioActual.id) {
                alert('❌ No tienes permisos para editar este proyecto');
                return;
            }
            
            if (!verificarTiempoEdicion(proyecto.fecha_creacion)) {
                const minutosTranscurridos = Math.floor((Date.now() - new Date(proyecto.fecha_creacion).getTime()) / 60000);
                alert(`❌ El tiempo límite para editar este proyecto (15 minutos) ha expirado.\n\nTiempo transcurrido: ${minutosTranscurridos} minutos`);
                return;
            }
            
            document.getElementById('edit_proyecto_id').value = proyectoId;
            document.getElementById('edit_titulo').value = proyecto.nombre || '';
            document.getElementById('edit_descripcion').value = proyecto.descripcion || '';
            document.getElementById('edit_programa').value = proyecto.programa_autor || '';
            document.getElementById('edit_github_url').value = proyecto.github_url || '';
            
            const imagenesContainer = document.getElementById('edit_imagenes_actuales');
            if (proyecto.imagenes && proyecto.imagenes.length > 0) {
                imagenesContainer.innerHTML = `
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                        Imágenes actuales (se mantendrán si no seleccionas nuevas):
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        ${proyecto.imagenes.map(img => `
                            <img src="${img}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                        `).join('')}
                    </div>
                `;
            } else {
                imagenesContainer.innerHTML = '<div style="font-size: 12px; color: #666;">No hay imágenes actuales</div>';
            }
            
            const pdfContainer = document.getElementById('edit_pdf_actual');
            if (proyecto.documento_pdf) {
                pdfContainer.innerHTML = `
                    <div style="font-size: 12px; color: #666;">
                        PDF actual: <a href="${proyecto.documento_pdf}" target="_blank" style="color: #10b981;">Ver PDF actual</a>
                    </div>
                `;
            } else {
                pdfContainer.innerHTML = '<div style="font-size: 12px; color: #666;">No hay PDF actual</div>';
            }
            
            document.getElementById('modal-editar-proyecto').style.display = 'flex';
        } else {
            alert('Error al cargar proyecto para editar');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar proyecto para editar');
    }
}

window.editarProyecto = editarProyecto;

// ==================== ACTUALIZAR PROYECTO ====================
async function actualizarProyecto(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById('btn-actualizar');
    const proyectoId = document.getElementById('edit_proyecto_id').value;
    
    formData.set('user_id', usuarioActual.id);
    
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/proyectos/${proyectoId}/editar`, {
            method: 'PUT',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Proyecto actualizado exitosamente!');
            document.getElementById('modal-editar-proyecto').style.display = 'none';
            this.reset();
            await cargarProyectos();
        } else {
            throw new Error(data.message || 'Error al actualizar proyecto');
        }
    } catch (error) {
        console.error('❌ Error:', error);
        alert('❌ Error al actualizar proyecto: ' + error.message);
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// ==================== ELIMINAR PROYECTO ====================
async function eliminarProyecto(proyectoId) {
    if (!confirm('¿Estás seguro de que quieres eliminar este proyecto?\nEsta acción no se puede deshacer.')) {
        return;
    }

    try {
        const response = await fetch(`/api/proyectos/${proyectoId}/eliminar`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: usuarioActual.id })
        });

        const data = await response.json();

        if (data.success) {
            alert('✅ Proyecto eliminado exitosamente');
            await cargarProyectos();
        } else {
            alert('❌ Error: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al eliminar proyecto');
    }
}

window.eliminarProyecto = eliminarProyecto;

// ==================== FUNCIONES DE COMENTARIOS ====================
async function cargarComentariosProyecto(proyectoId) {
    try {
        const user_id = document.getElementById('user_id').value;
        const response = await fetch(`/api/proyectos/${proyectoId}/comentarios?user_id=${user_id}`);
        const data = await response.json();
        
        const contenedor = document.getElementById(`mini-comentarios-${proyectoId}`);
        
        if (data.success && data.comentarios && data.comentarios.length > 0) {
            // Mostrar solo los primeros 2 comentarios
            const comentariosLimitados = data.comentarios.slice(0, 2);
            
            contenedor.innerHTML = comentariosLimitados.map(comentario => `
                <div class="mini-comentario">
                    <strong>${comentario.nombre || 'Usuario'} ${comentario.apellido || ''}:</strong>
                    <span>${comentario.contenido}</span>
                    <small>${formatearFechaMini(comentario.fecha_creacion)}</small>
                </div>
            `).join('');
            
            // Actualizar el texto del botón
            const boton = document.querySelector(`#comentarios-${proyectoId} .proyecto-comentarios`);
            boton.textContent = `${data.comentarios.length} comentarios`;
            
        } else {
            const boton = document.querySelector(`#comentarios-${proyectoId} .proyecto-comentarios`);
            boton.textContent = 'No hay comentarios';
        }
        
    } catch (error) {
        console.error('Error al cargar comentarios:', error);
        const boton = document.querySelector(`#comentarios-${proyectoId} .proyecto-comentarios`);
        boton.textContent = 'Error al cargar';
    }
}

function toggleComentariosProyecto(proyectoId) {
    const contenedor = document.getElementById(`mini-comentarios-${proyectoId}`);
    const estaVisible = contenedor.style.display === 'block';
    
    if (!estaVisible) {
        // Cargar comentarios si no se han cargado
        if (contenedor.innerHTML === '') {
            cargarComentariosProyecto(proyectoId);
        }
        contenedor.style.display = 'block';
    } else {
        contenedor.style.display = 'none';
    }
}

window.toggleComentariosProyecto = toggleComentariosProyecto;

// ==================== FUNCIONES AUXILIARES ====================
function formatearFecha(fechaString) {
    try {
        const fecha = new Date(fechaString);
        return fecha.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return 'Fecha no disponible';
    }
}

function formatearFechaMini(fechaString) {
    try {
        const fecha = new Date(fechaString);
        const ahora = new Date();
        const diferencia = ahora - fecha;
        const diferenciaMinutos = Math.floor(diferencia / (1000 * 60));
        const diferenciaHoras = Math.floor(diferencia / (1000 * 60 * 60));
        
        // Si es hace menos de 1 minuto
        if (diferenciaMinutos < 1) {
            return 'Ahora';
        }
        // Si es hace menos de 1 hora
        else if (diferenciaMinutos < 60) {
            return `Hace ${diferenciaMinutos}m`;
        }
        // Si es hace menos de 24 horas
        else if (diferenciaHoras < 24) {
            return `Hace ${diferenciaHoras}h`;
        }
        // Si es de hoy
        else if (fecha.toDateString() === ahora.toDateString()) {
            return 'Hoy';
        }
        // Si es de ayer
        else if (fecha.toDateString() === new Date(ahora - 86400000).toDateString()) {
            return 'Ayer';
        }
        // Para fechas más antiguas
        else {
            return fecha.toLocaleDateString('es-ES', {
                month: 'short',
                day: 'numeric'
            });
        }
    } catch (error) {
        return '';
    }
}

function abrirProyecto(proyectoId) {
    window.location.href = `/Detalles_Proyecto.html?id=${proyectoId}`;
}

window.abrirProyecto = abrirProyecto;

// ==================== MENÚS INTERACTIVOS ====================
function toggleProyectoMenu(proyectoId, event) {
    event.stopPropagation();
    const menu = document.getElementById(`menu-${proyectoId}`);
    
    // Cerrar menú anterior si hay uno abierto
    if (menuAbierto && menuAbierto !== menu) {
        menuAbierto.classList.remove('mostrar');
    }
    
    // Alternar el menú actual
    menu.classList.toggle('mostrar');
    menuAbierto = menu.classList.contains('mostrar') ? menu : null;
}

window.toggleProyectoMenu = toggleProyectoMenu;

function aplicarEventListenersFavoritos() {
    document.querySelectorAll('.proyecto-fav').forEach(function(btn) {
        btn.addEventListener('click', function() {
            btn.classList.toggle('active');
            var icon = btn.querySelector('i');
            if (btn.classList.contains('active')) {
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
            } else {
                icon.classList.remove('fa-solid');
                icon.classList.add('fa-regular');
            }
        });
    });
}

function configurarPDFInputs() {
    const pdfLabel = document.querySelector('.pdf-label');
    const pdfInput = document.getElementById('pdf-doc');
    
    if (pdfLabel && pdfInput) {
        pdfLabel.onclick = function() {
            pdfInput.click();
        };
        
        pdfInput.addEventListener('change', function() {
            const pdfName = document.getElementById('pdf-name');
            const pdfPreview = document.getElementById('pdf-preview');
            
            if (this.files.length > 0) {
                pdfName.textContent = 'Archivo seleccionado: ' + this.files[0].name;
                const url = URL.createObjectURL(this.files[0]);
                pdfPreview.innerHTML = `<a href="${url}" target="_blank" style="color:#10b981;font-weight:600;">Ver PDF</a>`;
            } else {
                pdfName.textContent = '';
                pdfPreview.innerHTML = '';
            }
        });
    }
    
    const editPdfLabel = document.querySelector('label[for="edit_pdf-doc"]');
    const editPdfInput = document.getElementById('edit_pdf-doc');
    
    if (editPdfLabel && editPdfInput) {
        editPdfLabel.onclick = function() {
            editPdfInput.click();
        };
        
        editPdfInput.addEventListener('change', function() {
            const pdfName = document.getElementById('edit_pdf-name');
            const pdfPreview = document.getElementById('edit_pdf-preview');
            
            if (this.files.length > 0) {
                pdfName.textContent = 'Nuevo archivo: ' + this.files[0].name;
                const url = URL.createObjectURL(this.files[0]);
                pdfPreview.innerHTML = `<a href="${url}" target="_blank" style="color:#10b981;font-weight:600;">Ver PDF</a>`;
            } else {
                pdfName.textContent = '';
                pdfPreview.innerHTML = '';
            }
        });
    }
}

function configurarNotificaciones() {
    const notiBtn = document.getElementById('notificaciones-btn');
    const notiPopover = document.getElementById('notificaciones-popover');
    
    if (notiBtn && notiPopover) {
        notiBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isVisible = notiPopover.style.display === 'block';
            
            // Cerrar menú de perfil si está abierto
            document.getElementById('popover-menu').style.display = 'none';
            
            notiPopover.style.display = isVisible ? 'none' : 'block';
        });
    }
    
    document.addEventListener('click', function(e) {
        if (notiPopover && !notiPopover.contains(e.target) && e.target !== notiBtn) {
            notiPopover.style.display = 'none';
        }
    });
}

function limpiarFiltros() {
    document.querySelectorAll('.filtros-form input, .filtros-form select').forEach(function(el) {
        if (!el.disabled) {
            if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        }
    });
    alert('Filtros limpiados.');
}

// ==================== EVENT LISTENERS GLOBALES ====================
document.addEventListener('click', function(e) {
    // Cerrar menú de proyectos al hacer clic fuera
    if (menuAbierto && !e.target.closest('.proyecto-acciones')) {
        menuAbierto.classList.remove('mostrar');
        menuAbierto = null;
    }
});
  </script>
</body>
</html>