<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIP - Proyecto Individual</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="/Feed_Proyectos.css">
  <style>
    /* ESTILOS ORIGINALES - MANTENER */
    .proyecto-acciones {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }

    .btn-editar, .btn-eliminar {
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .btn-editar {
        color: #3ec9a7;
    }

    .btn-editar:hover {
        background-color: #e8f8f4;
        transform: scale(1.1);
    }

    .btn-eliminar {
        color: #e53e3e;
    }

    .btn-eliminar:hover {
        background-color: #fde8e8;
        transform: scale(1.1);
    }

    /* ESTILOS PARA EL MENÚ DE 3 PUNTOS - AGREGAR */
    .proyecto-acciones {
        position: relative;
    }

    .menu-tres-puntos {
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        border-radius: 4px;
        font-size: 16px;
        color: #666;
        transition: all 0.3s ease;
    }

    .menu-tres-puntos:hover {
        background-color: #f0f0f0;
        transform: scale(1.1);
    }

    .menu-desplegable {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 8px 0;
        min-width: 120px;
        z-index: 100;
        display: none;
    }

    .menu-desplegable.mostrar {
        display: block;
    }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        color: #333;
        transition: background-color 0.2s;
    }

    .menu-item:hover {
        background-color: #f5f5f5;
    }

    .menu-item.editar {
        color: #3ec9a7;
    }

    .menu-item.eliminar {
        color: #e53e3e;
    }

    .menu-item i {
        font-size: 14px;
        width: 16px;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <header class="header">
      <img src="/img/logo.png" alt="SIP Logo" class="logo-header">
      <nav class="nav-header">
        <a href="/feed-proyectos"><i class="fa-solid fa-layer-group"></i> Proyectos</a>
        <a href="#" id="notificaciones-btn"><i class="fa-regular fa-bell"></i> Notificaciones</a>
        <div class="user-info" id="perfil-btn">
          <span class="user-avatar">D</span>
          <span class="user-name">Daniela</span>
        </div>
      </nav>
      <!-- Notificaciones Popover -->
    <div id="notificaciones-popover" class="notificaciones-popover">
      <div class="notificaciones-arrow"></div>
      <h3>Notificaciones</h3>
      <div class="notificacion-item">
        <span class="notif-avatar">A</span>
        <div>
          <strong>Respondió tu publicación</strong>
          <div class="notif-text">Te dare varias ideas para tu proyecto...</div>
        </div>
      </div>
      <div class="notificacion-item">
        <span class="notif-avatar">J</span>
        <div>
          <strong>Respondió tu publicación</strong>
          <div class="notif-text">Te dare varias ideas para tu proyecto...</div>
        </div>
      </div>
      <div class="notificacion-item">
        <span class="notif-avatar">D</span>
        <div>
          <strong>Respondió tu respuesta</strong>
          <div class="notif-text">Muchas gracias me sirvió mucho, sig...</div>
        </div>
      </div>
    </div>
    </header>

    <!-- MODAL SUBIR PROYECTO -->
    <div id="modal-subir-proyecto" class="modal-publicacion" style="display:none;">
      <div class="modal-content">
        <h2>Subir Proyecto</h2>
        <form id="form-subir-proyecto" enctype="multipart/form-data">
          <input type="hidden" name="user_id" id="user_id" value="16">
          
          <input type="text" name="titulo" placeholder="Título..." required />
          <textarea name="descripcion" placeholder="Ingrese la descripción..." required></textarea>
          
        <!-- SELECT DE PROGRAMA -->
        <div class="custom-select">
          <div class="select-selected">Selecciona tu programa</div>
          <div class="select-items select-hide">
            <div>Tecnólogo en Análisis y Desarrollo de Software</div>
            <div>Tecnólogo en Animación Digital</div>
            <div>Tecnólogo en Automatización de Sistemas Mecatrónicos</div>
            <div>Tecnólogo en Desarrollo de Sistemas Electrónicos Industriales</div>
            <div>Tecnólogo en Desarrollo Multimedia y Web</div>
            <div>Tecnólogo en Electricidad Industrial</div>
            <div>Tecnólogo en Gestión de la Producción Industrial</div>
            <div>Tecnólogo en Gestión de Proyectos de Desarrollo Económico y Social</div>
            <div>Tecnólogo en Gestión de Redes de Datos</div>
            <div>Tecnólogo en Gestión eficiente de la energía</div>
            <div>Tecnólogo en Implementación de Infraestructura de Tecnologías de la Información y las Comunicaciones</div>
            <div>Tecnólogo en Implementación y Mantenimiento de Sistemas de Instrumentación y Control de Procesos Industriales</div>
            <div>Tecnólogo en Supervisión de Redes de Distribución de Energía Eléctrica</div>
            <div>Técnico en Instalación de Redes Internas de Telecomunicaciones</div>
            <div>Técnico en Instalación de Sistemas Eléctricos Residenciales y Comerciales</div>
            <div>Técnico en Instrumentación Industrial</div>
            <div>Técnico en Integración de Contenidos Digitales</div>
            <div>Técnico en Mantenimiento e Instalación de Sistemas Solares Fotovoltaicos</div>
            <div>Técnico en Asistencia Administrativa</div>
            <div>Técnico en Atención Integral al Cliente</div>
            <div>Técnico en Control de la Seguridad Digital</div>
            <div>Técnico en Dibujo Mecánico</div>
            <div>Técnico en Electricista Industrial</div>
            <div>Técnico en Mantenimiento y Ensamble de Equipos Electrónicos</div>
            <div>Técnico en Modelado 3D para la Industria</div>
            <div>Técnico en Monitoreo Ambiental</div>
            <div>Técnico en Montaje y Mantenimiento de Redes Aéreas de Distribución de Energía Eléctrica</div>
            <div>Técnico en Procesos de Manufactura</div>
            <div>Técnico en Servicios y Operaciones Microfinancieras</div>
            <div>Técnico en Sistemas teleinformáticos</div>
            <div>Técnico en Programación de Aplicaciones para Dispositivos Móviles</div>
            <div>Técnico en Programación de Software</div>
            <div>Técnico en Programación para Aplicaciones</div>
          </div>
          
        </div>
        

          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">Agrega maximo 5 imagenes...</div>
          <input type="file" name="imagenes" accept="image/*" multiple style="margin-bottom:10px;">
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">
            Agrega documentación (PDF)...
          </div>
          <input type="file" name="documento_pdf" id="pdf-doc" accept="application/pdf" style="display:none;">
          <label for="pdf-doc" class="pdf-label">Seleccionar PDF</label>
          <span id="pdf-name"></span>
          <div id="pdf-preview" style="margin-bottom:10px;"></div>
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">Agrega enlace de Github (Codigo)...</div>
          <input type="url" name="github_url" placeholder="https://github.com/usuario/proyecto" />
          
          <div class="modal-btns">
            <button type="submit" id="btn-publicar" class="btn-modal">Publicar</button>
            <button type="button" id="btn-cancelar" class="btn-modal cancelar">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL EDITAR PROYECTO -->
    <div id="modal-editar-proyecto" class="modal-publicacion" style="display:none;">
      <div class="modal-content">
        <h2>Editar Proyecto</h2>
        <form id="form-editar-proyecto" enctype="multipart/form-data">
          <input type="hidden" name="user_id" id="edit_user_id" value="16">
          <input type="hidden" name="proyecto_id" id="edit_proyecto_id">
          
          <input type="text" name="titulo" id="edit_titulo" placeholder="Título..." required />
          <textarea name="descripcion" id="edit_descripcion" placeholder="Ingrese la descripción..." required></textarea>
          
          <!-- SELECT DE PROGRAMA -->
          <select name="programa" id="edit_programa" required style="width:100%; padding:12px; margin-bottom:18px; border:1.5px solid #3ec9a7; border-radius:12px;">
            <option value="">Selecciona tu programa</option>
            <option value="Desarrollo de Software">Tecnología en Desarrollo de Software</option>
            <option value="Redes y Telecomunicaciones">Redes y Telecomunicaciones</option>
          </select>
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">Agrega maximo 5 imagenes...</div>
          <input type="file" name="imagenes" id="edit_imagenes" accept="image/*" multiple style="margin-bottom:10px;">
          <div id="edit_imagenes_actuales" style="margin-bottom:10px;"></div>
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">
            Agrega documentación (PDF)...
          </div>
          <input type="file" name="documento_pdf" id="edit_pdf-doc" accept="application/pdf" style="display:none;">
          <label for="edit_pdf-doc" class="pdf-label">Seleccionar PDF</label>
          <span id="edit_pdf-name"></span>
          <div id="edit_pdf-preview" style="margin-bottom:10px;"></div>
          <div id="edit_pdf_actual" style="margin-bottom:10px;"></div>
          
          <div style="margin-bottom:10px; text-align:left; color:#444; font-weight:500;">Agrega enlace de Github (Codigo)...</div>
          <input type="url" name="github_url" id="edit_github_url" placeholder="https://github.com/usuario/proyecto" />
          
          <div class="modal-btns">
            <button type="submit" id="btn-actualizar" class="btn-modal">Actualizar</button>
            <button type="button" id="btn-cancelar-edicion" class="btn-modal cancelar">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Menú Popover de Usuario -->
    <div id="popover-menu" class="popover-menu">
      <div class="popover-arrow"></div>
      <div class="popover-content">
        <ul class="popover-list">
          <li>
            <span class="icon">
              <i class="fa-regular fa-user"></i>
            </span>
            <span>Perfil</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-solid fa-gear"></i>
            </span>
            <span>Configuración</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-regular fa-star"></i>
            </span>
            <span>Favoritos</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-regular fa-circle-question"></i>
            </span>
            <span>Ayuda</span>
          </li>
        </ul>
        <form action="/api/logout" method="POST" id="logoutForm">
          <input type="hidden" name="user_id" value="16">
          <button type="submit" class="logout-btn" id="logoutBtn">Cerrar sesión</button>
        </form>
      </div>
    </div>

    <main class="proyectos-main">
      <!-- Panel de filtros -->
      <aside class="filtros">
        <button class="btn-subir" type="button">Subir proyecto</button>
        <form class="filtros-form" action="/api/proyectos/buscar" method="GET" id="form-filtros">
          <input type="text" name="keyword" placeholder="Buscar por palabra clave...">
          <select name="programa">
            <option value="">Todos los programas</option>
            <option value="software">Desarrollo de Software</option>
            <option value="redes">Redes y Telecomunicaciones</option>
          </select>
          <select name="rol">
            <option value="">Todos los roles</option>
            <option value="aprendiz">Aprendiz</option>
            <option value="egresado">Egresado</option>
            <option value="instructor">Instructor</option>
          </select>
          <input type="date" name="fecha" placeholder="dd/mm/aaaa">
          <button type="submit" style="display:none;">Buscar</button>
        </form>
        <button class="btn-limpiar" type="button">Limpiar Filtros</button>
      </aside>

      <!-- Lista de proyectos -->
      <section class="proyectos-lista" id="proyectos-lista">
        <!-- Los proyectos se cargarán dinámicamente aquí -->
      </section>
    </main>

    

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <hr class="footer-line">
        <div class="footer-icons">
          <i class="fab fa-twitter"></i>
          <i class="fab fa-facebook"></i>
          <i class="fab fa-instagram"></i>
        </div>
        <hr class="footer-line">
      </div>
      <div class="footer-text">
        Copyright © 2025 SENA INTERACTIVE PORTAL
      </div>
      <div class="footer-links">
        <span>Información legal</span>
        <span>Política de privacidad</span>
      </div>
    </footer>
  </div>

  <script>
    // ===== FUNCIONES PARA EL MENÚ DE 3 PUNTOS =====
    let menuAbierto = null;

    function toggleProyectoMenu(proyectoId, event) {
        event.stopPropagation();
        const menu = document.getElementById(`menu-${proyectoId}`);
        
        // Cerrar menú anterior si hay uno abierto
        if (menuAbierto && menuAbierto !== menu) {
            menuAbierto.classList.remove('mostrar');
        }
        
        // Alternar el menú actual
        menu.classList.toggle('mostrar');
        menuAbierto = menu.classList.contains('mostrar') ? menu : null;
    }

    // Cerrar menú al hacer clic fuera de él
    document.addEventListener('click', function(e) {
        if (menuAbierto && !e.target.closest('.proyecto-acciones')) {
            menuAbierto.classList.remove('mostrar');
            menuAbierto = null;
        }
    });

    // ===== FUNCIONES PARA SUBIR Y MOSTRAR PROYECTOS =====

    // Función para cargar proyectos desde la API
    async function cargarProyectos() {
        try {
            console.log('Cargando proyectos...');
            
            const response = await fetch('/api/proyectos');
            
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Proyectos cargados:', data);
            
            if (data.success) {
                mostrarProyectos(data.proyectos);
            } else {
                throw new Error(data.message || 'Error al cargar proyectos');
            }
        } catch (error) {
            console.error('Error al cargar proyectos:', error);
            // Mantener los proyectos de ejemplo si hay error
            document.getElementById('proyectos-lista').innerHTML = `
                <div class="proyecto-card">
                    <div class="proyecto-header">
                        <span class="proyecto-titulo">App SIP</span>
                        <span class="proyecto-etiqueta egresado">Egresado</span>
                        <span class="proyecto-fecha">${new Date().toLocaleDateString('es-ES')}</span>
                        <button class="proyecto-fav"><i class="fa-regular fa-star"></i></button>
                    </div>
                    <div class="proyecto-autor">Ana Gomez</div>
                    <div class="proyecto-carrera">Tecnología en Desarrollo de Software</div>
                    <div class="proyecto-desc">
                        Proyecto de ejemplo - Los proyectos reales se cargarán del servidor
                    </div>
                    <div class="proyecto-footer">
                        <span class="proyecto-comentarios" style="cursor:pointer; font-weight:600;">No hay comentarios</span>
                        <button class="btn-abrir">Abrir</button>
                    </div>
                </div>
            `;
        }
    }

    // Función para mostrar proyectos en la interfaz
    function mostrarProyectos(proyectos) {
        const contenedor = document.getElementById('proyectos-lista');
        
        if (!proyectos || proyectos.length === 0) {
            contenedor.innerHTML = `
                <div class="proyecto-card" style="text-align: center; padding: 40px;">
                    <h3>No hay proyectos publicados aún</h3>
                    <p>Sé el primero en compartir tu proyecto!</p>
                </div>
            `;
            return;
        }

        contenedor.innerHTML = proyectos.map((proyecto, index) => `
            <div class="proyecto-card" data-proyecto-id="${proyecto.ID_proyecto}">
                <div class="proyecto-header">
                    <span class="proyecto-titulo">${proyecto.nombre || 'Sin título'}</span>
                    <span class="proyecto-etiqueta egresado">Egresado</span>
                    <span class="proyecto-fecha">${formatearFecha(proyecto.fecha_creacion)}</span>
                    
                    <!-- MENÚ DE 3 PUNTOS -->
                    <div class="proyecto-acciones">
                        <button class="menu-tres-puntos" onclick="toggleProyectoMenu(${proyecto.ID_proyecto}, event)">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        
                        <div class="menu-desplegable" id="menu-${proyecto.ID_proyecto}">
                            <button class="menu-item editar" onclick="editarProyecto(${proyecto.ID_proyecto})">
                                <i class="fas fa-edit"></i>
                                Editar
                            </button>
                            <button class="menu-item eliminar" onclick="eliminarProyecto(${proyecto.ID_proyecto})">
                                <i class="fas fa-trash"></i>
                                Eliminar
                            </button>
                        </div>
                        
                        <button class="proyecto-fav"><i class="fa-regular fa-star"></i></button>
                    </div>
                </div>
                
                <!-- AUTOR Y CARRERA -->
                <div class="proyecto-autor">${proyecto.autor_completo || (proyecto.nombre_autor + ' ' + proyecto.apellido_autor) || 'Autor no disponible'}</div>
                <div class="proyecto-carrera">${proyecto.programa_autor || 'Tecnología en Desarrollo de Software'}</div>
                
                <!-- DESCRIPCIÓN -->
                <div class="proyecto-desc">${proyecto.descripcion || 'Sin descripción'}</div>
                
                ${proyecto.github_url ? `
                    <div class="proyecto-github" style="margin: 8px 0;">
                        <a href="${proyecto.github_url}" target="_blank" style="color: #10b981; text-decoration: none; font-weight: 600;">
                            <i class="fab fa-github"></i> Ver código en GitHub
                        </a>
                    </div>
                ` : ''}
                
                ${proyecto.documento_pdf ? `
                    <div class="proyecto-pdf" style="margin: 8px 0;">
                        <a href="${proyecto.documento_pdf}" target="_blank" style="color: #e53e3e; text-decoration: none; font-weight: 600;">
                            <i class="far fa-file-pdf"></i> Ver documentación PDF
                        </a>
                    </div>
                ` : ''}
                
                <div class="proyecto-footer">
                    <span class="proyecto-comentarios" style="cursor:pointer; font-weight:600;">No hay comentarios</span>
                    <button class="btn-abrir" onclick="abrirProyecto(${proyecto.ID_proyecto})">Abrir</button>
                </div>
            </div>
        `).join('');
    }

    // Función para formatear fecha
    function formatearFecha(fechaString) {
        try {
            const fecha = new Date(fechaString);
            return fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (error) {
            return 'Fecha no disponible';
        }
    }

    // Función para abrir proyecto
    function abrirProyecto(proyectoId) {
        alert(`Abriendo proyecto ${proyectoId} - Esta funcionalidad se implementará después`);
    }

    // ===== MANEJAR ENVÍO DEL FORMULARIO =====

    document.getElementById('form-subir-proyecto').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = document.getElementById('btn-publicar');
        
        // Validar campos requeridos
        const titulo = formData.get('titulo');
        const descripcion = formData.get('descripcion');
        const programa = formData.get('programa');
        
        if (!titulo || !descripcion || !programa) {
            alert('❌ Por favor completa todos los campos requeridos');
            return;
        }
        
        // Mostrar loading
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';
        submitBtn.disabled = true;
        
        try {
            console.log('Enviando formulario...');
            
            const response = await fetch('/api/proyectos/crear', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            console.log('Respuesta del servidor:', data);
            
            if (data.success) {
                alert('✅ Proyecto publicado exitosamente!');
                
                // Cerrar modal
                document.getElementById('modal-subir-proyecto').style.display = 'none';
                
                // Limpiar formulario
                this.reset();
                document.getElementById('pdf-name').textContent = '';
                document.getElementById('pdf-preview').innerHTML = '';
                
                // Recargar proyectos
                await cargarProyectos();
            } else {
                throw new Error(data.message || 'Error al publicar proyecto');
            }
            
        } catch (error) {
            console.error('Error al publicar proyecto:', error);
            alert('❌ Error al publicar proyecto: ' + error.message);
        } finally {
            // Restaurar botón
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // ===== FUNCIONES PARA EDITAR Y ELIMINAR PROYECTOS =====

    // FUNCIÓN PARA EDITAR PROYECTO
    async function editarProyecto(proyectoId) {
        try {
            console.log('Editando proyecto:', proyectoId);
            
            // Obtener datos actuales del proyecto
            const response = await fetch(`/api/proyectos/${proyectoId}`);
            const data = await response.json();
            
            if (data.success && data.proyecto) {
                const proyecto = data.proyecto;
                
                // Llenar el modal de edición con los datos actuales
                document.getElementById('edit_proyecto_id').value = proyectoId;
                document.getElementById('edit_titulo').value = proyecto.nombre || '';
                document.getElementById('edit_descripcion').value = proyecto.descripcion || '';
                document.getElementById('edit_programa').value = proyecto.programa_autor || '';
                document.getElementById('edit_github_url').value = proyecto.github_url || '';
                
                // Mostrar imágenes actuales
                const imagenesContainer = document.getElementById('edit_imagenes_actuales');
                if (proyecto.imagenes && proyecto.imagenes.length > 0) {
                    imagenesContainer.innerHTML = `
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                            Imágenes actuales (se mantendrán si no seleccionas nuevas):
                        </div>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            ${proyecto.imagenes.map(img => `
                                <img src="${img}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                            `).join('')}
                        </div>
                    `;
                } else {
                    imagenesContainer.innerHTML = '<div style="font-size: 12px; color: #666;">No hay imágenes actuales</div>';
                }
                
                // Mostrar PDF actual
                const pdfContainer = document.getElementById('edit_pdf_actual');
                if (proyecto.documento_pdf) {
                    pdfContainer.innerHTML = `
                        <div style="font-size: 12px; color: #666;">
                            PDF actual: <a href="${proyecto.documento_pdf}" target="_blank" style="color: #10b981;">Ver PDF actual</a>
                        </div>
                    `;
                } else {
                    pdfContainer.innerHTML = '<div style="font-size: 12px; color: #666;">No hay PDF actual</div>';
                }
                
                // Mostrar modal de edición
                document.getElementById('modal-editar-proyecto').style.display = 'flex';
            } else {
                alert('Error al cargar proyecto para editar');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al cargar proyecto para editar');
        }
    }

    // FUNCIÓN PARA ELIMINAR PROYECTO
    async function eliminarProyecto(proyectoId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este proyecto?\nEsta acción no se puede deshacer.')) {
            return;
        }

        try {
            const user_id = document.getElementById('user_id').value;
            
            const response = await fetch(`/api/proyectos/${proyectoId}/eliminar`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_id })
            });

            const data = await response.json();

            if (data.success) {
                alert('✅ Proyecto eliminado exitosamente');
                // Recargar la lista de proyectos
                await cargarProyectos();
            } else {
                alert('❌ Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('❌ Error al eliminar proyecto');
        }
    }

    // MANEJAR ENVÍO DEL FORMULARIO DE EDICIÓN
    document.getElementById('form-editar-proyecto').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = document.getElementById('btn-actualizar');
        const proyectoId = document.getElementById('edit_proyecto_id').value;
        
        // Mostrar loading
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
        submitBtn.disabled = true;
        
        try {
            console.log('Actualizando proyecto...');
            
            const response = await fetch(`/api/proyectos/${proyectoId}/editar`, {
                method: 'PUT',
                body: formData
            });
            
            const data = await response.json();
            console.log('Respuesta del servidor:', data);
            
            if (data.success) {
                alert('✅ Proyecto actualizado exitosamente!');
                
                // Cerrar modal
                document.getElementById('modal-editar-proyecto').style.display = 'none';
                
                // Limpiar formulario
                this.reset();
                document.getElementById('edit_imagenes_actuales').innerHTML = '';
                document.getElementById('edit_pdf_actual').innerHTML = '';
                
                // Recargar proyectos
                await cargarProyectos();
            } else {
                throw new Error(data.message || 'Error al actualizar proyecto');
            }
            
        } catch (error) {
            console.error('Error al actualizar proyecto:', error);
            alert('❌ Error al actualizar proyecto: ' + error.message);
        } finally {
            // Restaurar botón
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // ===== FUNCIONALIDAD EXISTENTE =====

    // MODAL SUBIR PROYECTO
    document.querySelector('.btn-subir').addEventListener('click', function() {
      document.getElementById('modal-subir-proyecto').style.display = 'flex';
    });

    // PDF personalizado
    document.querySelector('.pdf-label').onclick = function() {
      document.getElementById('pdf-doc').click();
    };
    document.getElementById('pdf-doc').addEventListener('change', function() {
      const pdfName = document.getElementById('pdf-name');
      const pdfPreview = document.getElementById('pdf-preview');
      if (this.files.length > 0) {
        pdfName.textContent = 'Archivo seleccionado: ' + this.files[0].name;
        const file = this.files[0];
        const url = URL.createObjectURL(file);
        pdfPreview.innerHTML = `<a href="${url}" target="_blank" style="color:#10b981;font-weight:600;">Ver PDF</a>`;
      } else {
        pdfName.textContent = '';
        pdfPreview.innerHTML = '';
      }
    });

    // PDF personalizado para edición
    document.querySelector('label[for="edit_pdf-doc"]').onclick = function() {
        document.getElementById('edit_pdf-doc').click();
    };

    document.getElementById('edit_pdf-doc').addEventListener('change', function() {
        const pdfName = document.getElementById('edit_pdf-name');
        const pdfPreview = document.getElementById('edit_pdf-preview');
        if (this.files.length > 0) {
            pdfName.textContent = 'Nuevo archivo seleccionado: ' + this.files[0].name;
            const file = this.files[0];
            const url = URL.createObjectURL(file);
            pdfPreview.innerHTML = `<a href="${url}" target="_blank" style="color:#10b981;font-weight:600;">Vista previa del nuevo PDF</a>`;
        } else {
            pdfName.textContent = '';
            pdfPreview.innerHTML = '';
        }
    });

    // CERRAR MODAL DE EDICIÓN
    document.getElementById('btn-cancelar-edicion').onclick = function() {
        document.getElementById('modal-editar-proyecto').style.display = 'none';
    };

    document.getElementById('modal-editar-proyecto').addEventListener('click', function(e) {
        if (e.target === this) this.style.display = 'none';
    });

    // Menú comentario
    window.toggleMenu = function(btn) {
      document.querySelectorAll('.comentario-menu').forEach(menu => menu.style.display = 'none');
      var menu = btn.nextElementSibling;
      menu.style.display = 'block';
      window.currentMenu = menu;
    }
    // Cerrar menú al hacer clic fuera
    document.addEventListener('click', function(e) {
      if (window.currentMenu && !window.currentMenu.contains(e.target) && e.target.className.indexOf('menu-btn') === -1) {
        window.currentMenu.style.display = 'none';
        window.currentMenu = null;
      }
    });
    // Evitar cierre al hacer clic en el botón de menú
    document.querySelectorAll('.publicacion-menu-btn, .comentario-menu-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    });

    // Mostrar/ocultar comentarios por publicación
    function toggleComentarios(btn, listaId) {
      var lista = document.getElementById(listaId);
      if (lista.style.display === 'none' || lista.style.display === '') {
        lista.style.display = 'block';
      } else {
        lista.style.display = 'none';
      }
    }

    // Ocultar modal al hacer clic en "Cancelar" o fuera del contenido
    document.getElementById('btn-cancelar').onclick = function() {
      document.getElementById('modal-subir-proyecto').style.display = 'none';
    };
    document.getElementById('modal-subir-proyecto').addEventListener('click', function(e) {
      if (e.target === this) this.style.display = 'none';
    });

    // Botón "Limpiar Filtros"
    document.querySelector('.btn-limpiar').addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.filtros-form input, .filtros-form select').forEach(function(el) {
        if (!el.disabled) {
          if (el.tagName === 'SELECT') el.selectedIndex = 0;
          else el.value = '';
        }
      });
      alert('Filtros limpiados.');
    });

    // Botones de estrella (favorito)
    document.querySelectorAll('.proyecto-fav').forEach(function(btn) {
      btn.addEventListener('click', function() {
        btn.classList.toggle('active');
        var icon = btn.querySelector('i');
        if (btn.classList.contains('active')) {
          icon.classList.remove('fa-regular');
          icon.classList.add('fa-solid');
        } else {
          icon.classList.remove('fa-solid');
          icon.classList.add('fa-regular');
        }
      });
    });

    // MENÚ POPOVER USUARIO
    const perfilBtn = document.getElementById('perfil-btn');
    const popoverMenu = document.getElementById('popover-menu');

    perfilBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (popoverMenu.style.display === 'block') {
        popoverMenu.style.display = 'none';
      } else {
        const rect = perfilBtn.getBoundingClientRect();
        popoverMenu.style.display = 'block';
        popoverMenu.style.position = 'absolute';
        popoverMenu.style.top = (rect.bottom + window.scrollY + 10) + 'px';
        popoverMenu.style.left = (rect.left + rect.width/2 - 160) + 'px';
      }
    });

    document.addEventListener('click', function(e) {
      if (!popoverMenu.contains(e.target) && e.target !== perfilBtn) {
        popoverMenu.style.display = 'none';
      }
    });

    document.querySelectorAll('.popover-list li').forEach((li, idx) => {
      li.addEventListener('click', () => {
        switch(idx) {
          case 0: alert('Ir al Perfil'); break;
          case 1: alert('Ir a Configuración'); break;
          case 2: alert('Ir a Favoritos'); break;
          case 3: alert('Ir a Ayuda'); break;
        }
        popoverMenu.style.display = 'none';
      });
    });

    // Notificaciones Popover
    const notiBtn = document.getElementById('notificaciones-btn');
    const notiPopover = document.getElementById('notificaciones-popover');
    notiBtn.onclick = function(e) {
      e.stopPropagation();
      notiPopover.style.display = notiPopover.style.display === 'block' ? 'none' : 'block';
      popoverMenu.style.display = 'none';
    };
    notiPopover.onclick = function(e) {
      e.stopPropagation();
    };

    // ===== INICIALIZAR =====

    // Cargar proyectos cuando la página se carga
    document.addEventListener('DOMContentLoaded', function() {
        cargarProyectos();
    });

     
    const selected = document.querySelector('.select-selected');
    const items = document.querySelector('.select-items');

    selected.addEventListener('click', () => {
      items.classList.toggle('select-hide');
    });

    items.querySelectorAll('div').forEach(option => {
      option.addEventListener('click', () => {
        selected.textContent = option.textContent;
        items.classList.add('select-hide');
      });
    });

    document.addEventListener('click', e => {
      if (!e.target.closest('.custom-select')) {
        items.classList.add('select-hide');
      }
    });


  </script>
</body>
</html>