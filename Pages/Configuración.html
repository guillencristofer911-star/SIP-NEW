<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIP - Configuraci√≥n</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="/configuracion.css">
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <header class="header">
      <img src="/img/logo.png" alt="SIP Logo" class="logo-header">
      <nav class="nav-header">
        <a href="/feed-proyectos"><i class="fa-solid fa-layer-group"></i> Proyectos</a>
        <a href="#" id="notificaciones-btn"><i class="fa-regular fa-bell"></i> Notificaciones</a>
        <div class="user-info" id="perfil-btn">
          <span class="user-avatar">D</span>
          <span class="user-name">Daniela</span>
        </div>
      </nav>
      
      <!-- Notificaciones Popover -->
      <div id="notificaciones-popover" class="notificaciones-popover">
        <div class="notificaciones-arrow"></div>
        <h3>Notificaciones</h3>
        <div class="notificacion-item">
          <span class="notif-avatar">A</span>
          <div>
            <strong>Respondi√≥ tu publicaci√≥n</strong>
            <div class="notif-text">Te dare varias ideas para tu proyecto...</div>
          </div>
        </div>
        <div class="notificacion-item">
          <span class="notif-avatar">J</span>
          <div>
            <strong>Respondi√≥ tu publicaci√≥n</strong>
            <div class="notif-text">Te dare varias ideas para tu proyecto...</div>
          </div>
        </div>
        <div class="notificacion-item">
          <span class="notif-avatar">D</span>
          <div>
            <strong>Respondi√≥ tu respuesta</strong>
            <div class="notif-text">Muchas gracias me sirvi√≥ mucho, sig...</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Men√∫ Popover de Usuario -->
    <div id="popover-menu" class="popover-menu">
      <div class="popover-arrow"></div>
      <div class="popover-content">
        <ul class="popover-list">
          <li>
            <span class="icon">
              <i class="fa-regular fa-user"></i>
            </span>
            <span>Perfil</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-solid fa-gear"></i>
            </span>
            <span>Configuraci√≥n</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-regular fa-star"></i>
            </span>
            <span>Favoritos</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-regular fa-circle-question"></i>
            </span>
            <span>Ayuda</span>
          </li>
        </ul>
        <form action="/api/logout" method="POST" id="logoutForm">
          <input type="hidden" name="user_id" id="logout_user_id">
          <input type="hidden" name="email" id="logout_email">
          <button type="submit" class="logout-btn" id="logoutBtn">Cerrar sesi√≥n</button>
        </form>
      </div>
    </div>

    <!-- Secci√≥n de configuraci√≥n de perfil -->
    <main class="main-content config-main">
      <div class="config-container">
        <h1 class="config-title">Configuraci√≥n</h1>
        <div class="config-panels">
          <div class="profile-card">
            <div class="profile-avatar" id="profile-avatar">D</div>
            <div class="profile-name" id="profile-name">Cargando...</div>
            <div class="profile-status" id="profile-status">Cargando...</div>
            <div class="profile-info" id="profile-documento">Cargando...</div>
            <div class="profile-info" id="profile-email">Cargando...</div>
            <div class="profile-info" id="profile-programa">Cargando...</div>
            <button class="profile-extra-btn" id="btn-eliminar-cuenta">Eliminar cuenta</button>
          </div>
          <div class="profile-form-card">
            <h2 class="profile-form-title">Editar Datos Perfil</h2>
            <form class="profile-form" action="#" method="POST" id="form-editar-perfil">
              <input type="hidden" name="user_id" id="form-user-id">
              
              <!-- Informaci√≥n personal (solo lectura) -->
              <div class="form-section">
                <h3 class="form-section-title">Informaci√≥n Personal</h3>
                <div class="profile-input-group">
                  <label for="form-nombre">Nombre Completo</label>
                  <input type="text" name="nombre" id="form-nombre" class="profile-input" readonly>
                </div>
                <div class="profile-input-group">
                  <label for="form-documento">Documento</label>
                  <input type="text" name="documento" id="form-documento" class="profile-input" readonly>
                </div>
                <div class="profile-input-group">
                  <label for="form-rol">Rol</label>
                  <input type="text" name="rol" id="form-rol" class="profile-input" readonly>
                  <div class="role-change-notice">
                    Para cambiar tu rol, env√≠a un correo a tps2127@gmail.com solicitando el cambio.
                  </div>
                </div>
              </div>
              
              <!-- Programa -->
              <div class="profile-input-group">
                <label for="form-programa">Programa</label>
                <select name="programa" id="form-programa" class="profile-select">
                  <option value="">Selecciona un programa</option>
                  <option value="Tecn√≥logo en An√°lisis y Desarrollo de Software">Tecn√≥logo en An√°lisis y Desarrollo de Software</option>
                  <option value="Tecn√≥logo en Animaci√≥n Digital">Tecn√≥logo en Animaci√≥n Digital</option>
                  <option value="Tecn√≥logo en Automatizaci√≥n de Sistemas Mecatr√≥nicos">Tecn√≥logo en Automatizaci√≥n de Sistemas Mecatr√≥nicos</option>
                  <option value="Tecn√≥logo en Desarrollo de Sistemas Electr√≥nicos Industriales">Tecn√≥logo en Desarrollo de Sistemas Electr√≥nicos Industriales</option>
                  <option value="Tecn√≥logo en Desarrollo Multimedia y Web">Tecn√≥logo en Desarrollo Multimedia y Web</option>
                  <option value="Tecn√≥logo en Electricidad Industrial">Tecn√≥logo en Electricidad Industrial</option>
                  <option value="Tecn√≥logo en Gesti√≥n de la Producci√≥n Industrial">Tecn√≥logo en Gesti√≥n de la Producci√≥n Industrial</option>
                  <option value="Tecn√≥logo en Gesti√≥n de Proyectos de Desarrollo Econ√≥mico y Social">Tecn√≥logo en Gesti√≥n de Proyectos de Desarrollo Econ√≥mico y Social</option>
                  <option value="Tecn√≥logo en Gesti√≥n de Redes de Datos">Tecn√≥logo en Gesti√≥n de Redes de Datos</option>
                  <option value="Tecn√≥logo en Gesti√≥n eficiente de la energ√≠a">Tecn√≥logo en Gesti√≥n eficiente de la energ√≠a</option>
                  <option value="Tecn√≥logo en Implementaci√≥n de Infraestructura de Tecnolog√≠as de la Informaci√≥n y las Comunicaciones">Tecn√≥logo en Implementaci√≥n de Infraestructura de Tecnolog√≠as de la Informaci√≥n y las Comunicaciones</option>
                  <option value="Tecn√≥logo en Implementaci√≥n y Mantenimiento de Sistemas de Instrumentaci√≥n y Control de Procesos Industriales">Tecn√≥logo en Implementaci√≥n y Mantenimiento de Sistemas de Instrumentaci√≥n y Control de Procesos Industriales</option>
                  <option value="Tecn√≥logo en Supervisi√≥n de Redes de Distribuci√≥n de Energ√≠a El√©ctrica">Tecn√≥logo en Supervisi√≥n de Redes de Distribuci√≥n de Energ√≠a El√©ctrica</option>
                  <option value="T√©cnico en Instalaci√≥n de Redes Internas de Telecomunicaciones">T√©cnico en Instalaci√≥n de Redes Internas de Telecomunicaciones</option>
                  <option value="T√©cnico en Instalaci√≥n de Sistemas El√©ctricos Residenciales y Comerciales">T√©cnico en Instalaci√≥n de Sistemas El√©ctricos Residenciales y Comerciales</option>
                  <option value="T√©cnico en Instrumentaci√≥n Industrial">T√©cnico en Instrumentaci√≥n Industrial</option>
                  <option value="T√©cnico en Integraci√≥n de Contenidos Digitales">T√©cnico en Integraci√≥n de Contenidos Digitales</option>
                  <option value="T√©cnico en Mantenimiento e Instalaci√≥n de Sistemas Solares Fotovoltaicos">T√©cnico en Mantenimiento e Instalaci√≥n de Sistemas Solares Fotovoltaicos</option>
                  <option value="T√©cnico en Asistencia Administrativa">T√©cnico en Asistencia Administrativa</option>
                  <option value="T√©cnico en Atenci√≥n Integral al Cliente">T√©cnico en Atenci√≥n Integral al Cliente</option>
                  <option value="T√©cnico en Control de la Seguridad Digital">T√©cnico en Control de la Seguridad Digital</option>
                  <option value="T√©cnico en Dibujo Mec√°nico">T√©cnico en Dibujo Mec√°nico</option>
                  <option value="T√©cnico en Electricista Industrial">T√©cnico en Electricista Industrial</option>
                  <option value="T√©cnico en Mantenimiento y Ensamble de Equipos Electr√≥nicos">T√©cnico en Mantenimiento y Ensamble de Equipos Electr√≥nicos</option>
                  <option value="T√©cnico en Modelado 3D para la Industria">T√©cnico en Modelado 3D para la Industria</option>
                  <option value="T√©cnico en Monitoreo Ambiental">T√©cnico en Monitoreo Ambiental</option>
                  <option value="T√©cnico en Montaje y Mantenimiento de Redes A√©reas de Distribuci√≥n de Energ√≠a El√©ctrica">T√©cnico en Montaje y Mantenimiento de Redes A√©reas de Distribuci√≥n de Energ√≠a El√©ctrica</option>
                  <option value="T√©cnico en Procesos de Manufactura">T√©cnico en Procesos de Manufactura</option>
                  <option value="T√©cnico en Servicios y Operaciones Microfinancieras">T√©cnico en Servicios y Operaciones Microfinancieras</option>
                  <option value="T√©cnico en Sistemas teleinform√°ticos">T√©cnico en Sistemas teleinform√°ticos</option>
                  <option value="T√©cnico en Programaci√≥n de Aplicaciones para Dispositivos M√≥viles">T√©cnico en Programaci√≥n de Aplicaciones para Dispositivos M√≥viles</option>
                  <option value="T√©cnico en Programaci√≥n de Software">Tecnico en Programaci√≥n de Software</option>
                  <option value="T√©cnico en Programaci√≥n para Aplicaciones">T√©cnico en Programaci√≥n para Aplicaciones</option>
                </select>
              </div>
              
              <!-- Cambio de correo -->
              <div class="form-section">
                <h3 class="form-section-title">Cambiar Correo Electr√≥nico</h3>
                <div class="profile-input-group">
                  <label for="form-email">Nuevo Correo Electr√≥nico</label>
                  <input type="email" name="email" id="form-email" class="profile-input" placeholder="nuevo@ejemplo.com" required>
                </div>
                <div class="profile-input-group">
                  <label for="form-email-confirm">Confirmar Nuevo Correo</label>
                  <input type="email" name="email_confirm" id="form-email-confirm" class="profile-input" placeholder="nuevo@ejemplo.com" required>
                </div>
              </div>
              
              <!-- Cambio de contrase√±a -->
              <div class="form-section">
                <h3 class="form-section-title">Cambiar Contrase√±a</h3>
                <div class="profile-input-group">
                  <label for="form-password-actual">Contrase√±a Actual</label>
                  <input type="password" name="password_actual" id="form-password-actual" class="profile-input" placeholder="Ingresa tu contrase√±a actual">
                </div>
                <div class="profile-input-group">
                  <label for="form-password-nueva">Nueva Contrase√±a</label>
                  <input type="password" name="password_nueva" id="form-password-nueva" class="profile-input" placeholder="Ingresa tu nueva contrase√±a">
                </div>
                <div class="profile-input-group">
                  <label for="form-password-confirm">Confirmar Nueva Contrase√±a</label>
                  <input type="password" name="password_confirm" id="form-password-confirm" class="profile-input" placeholder="Confirma tu nueva contrase√±a">
                </div>
              </div>
              
              <button type="submit" class="profile-save-btn">Guardar cambios</button>
            </form>
          </div>
        </div>
        <div class="profile-warning">
          Si desea cambiar otros datos personales, debe comunicarse con tps2127@gmail.com para solicitar el cambio ya que son datos sensibles
        </div>
      </div>
    </main>

    <!-- MODAL ELIMINAR CUENTA -->
    <div id="modal-eliminar-cuenta" class="modal-eliminar-cuenta" style="display:none;">
      <div class="modal-eliminar-content">
        <div class="modal-eliminar-title">¬øEsta seguro de eliminar cuenta?</div>
        <form action="/api/cuenta/eliminar" method="POST" id="form-eliminar-cuenta">
          <input type="hidden" name="user_id" id="eliminar-user-id">
          <input type="hidden" name="email" id="eliminar-email">
          <input type="hidden" name="nombre" id="eliminar-nombre">
          <input type="hidden" name="confirmacion" value="true">
          <div class="modal-eliminar-btns">
            <button type="submit" id="btn-confirmar-eliminar" class="btn-eliminar">Eliminar</button>
            <button type="button" id="btn-cancelar-eliminar" class="btn-cancelar">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-content">
        <hr class="footer-line">
        <div class="footer-icons">
          <i class="fab fa-twitter"></i>
          <i class="fab fa-facebook-f"></i>
          <i class="fab fa-instagram"></i>
        </div>
        <hr class="footer-line">
      </div>
      <div class="footer-text">
        Copyright ¬© 2025 SENA INTERACTIVE PORTAL
      </div>
      <div class="footer-links">
        <span>Informaci√≥n legal</span>
        <span>Pol√≠tica de privacidad</span>
      </div>
    </footer>
  </div>

  <script>
    // ==================== VARIABLES GLOBALES ====================
    let usuarioActual = null;
    let token = null;
    
    // ==================== INICIALIZACI√ìN ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Iniciando p√°gina de configuraci√≥n...');
        
        // Verificar autenticaci√≥n
        verificarAutenticacion();
        
        // Configurar event listeners
        configurarEventListeners();
        
        // Cargar datos del usuario
        cargarDatosUsuario();
    });
    
    // ==================== AUTENTICACI√ìN ====================
    function verificarAutenticacion() {
        token = localStorage.getItem('token');
        const usuarioStr = localStorage.getItem('usuario');
        
        if (!token || !usuarioStr) {
            console.log('‚ùå No hay sesi√≥n activa, redirigiendo al login...');
            alert('Debes iniciar sesi√≥n para acceder a esta p√°gina');
            window.location.href = '/login';
            return;
        }
        
        try {
            usuarioActual = JSON.parse(usuarioStr);
            console.log('‚úÖ Usuario autenticado:', usuarioActual);
            
            // Actualizar header con info del usuario
            actualizarHeaderUsuario();
            
        } catch (error) {
            console.error('Error al parsear usuario:', error);
            alert('Error en la sesi√≥n. Por favor inicia sesi√≥n nuevamente.');
            window.location.href = '/login';
        }
    }
    
    function actualizarHeaderUsuario() {
        const userNameElement = document.querySelector('.user-name');
        const userAvatarElement = document.querySelector('.user-avatar');
        
        if (userNameElement && usuarioActual) {
            const nombreCorto = usuarioActual.nombre_corto || 
                               usuarioActual.nombre?.split(' ')[0] || 
                               'Usuario';
            userNameElement.textContent = nombreCorto;
        }
        
        if (userAvatarElement && usuarioActual) {
            const inicial = (usuarioActual.nombre_corto || 
                            usuarioActual.nombre?.charAt(0) || 
                            'U').toUpperCase();
            userAvatarElement.textContent = inicial;
        }
    }
    
    // ==================== CARGAR DATOS DEL USUARIO ====================
    async function cargarDatosUsuario() {
        try {
            console.log('üìñ Cargando datos del usuario...');
            
            if (usuarioActual) {
                console.log('‚úÖ Usando datos de localStorage:', usuarioActual);
                
                // Crear nombre completo
                const nombreCompleto = `${usuarioActual.nombre || ''} ${usuarioActual.apellido || ''}`.trim() || 
                                     usuarioActual.nombre_completo || 
                                     'Nombre no disponible';
                
                // Obtener el rol
                const tipoUsuario = usuarioActual.rol_nombre || 
                                  (usuarioActual.rol === 3 ? 'Egresado' : 
                                   usuarioActual.rol === 2 ? 'Aprendiz' : 
                                   usuarioActual.rol === 1 ? 'Administrador' : 'Usuario');
                
                // Obtener el documento
                const documento = usuarioActual.documento || 
                                usuarioActual.numero_documento || 
                                'Documento no disponible';
                
                // Obtener el correo
                const correo = usuarioActual.correo || 
                             usuarioActual.email || 
                             'Email no disponible';
                
                // Obtener el programa
                const programa = usuarioActual.programa_autor || 
                               usuarioActual.programa || 
                               usuarioActual.nombre_programa ||
                               usuarioActual.programa_formacion ||
                               'Programa no especificado';
                
                console.log('üìã Datos extra√≠dos:', { nombreCompleto, tipoUsuario, documento, correo, programa });
                
                // Mostrar los datos en la tarjeta de perfil
                document.getElementById('profile-avatar').textContent = nombreCompleto.charAt(0).toUpperCase();
                document.getElementById('profile-name').textContent = nombreCompleto;
                document.getElementById('profile-status').textContent = tipoUsuario;
                document.getElementById('profile-documento').textContent = `Documento: ${documento}`;
                document.getElementById('profile-email').textContent = `Correo: ${correo}`;
                document.getElementById('profile-programa').textContent = `Programa: ${programa}`;
                
                // Actualizar formularios
                document.getElementById('form-user-id').value = documento;
                document.getElementById('form-nombre').value = nombreCompleto;
                document.getElementById('form-documento').value = documento;
                document.getElementById('form-rol').value = tipoUsuario;
                document.getElementById('form-programa').value = programa;
                document.getElementById('form-email').value = correo;
                document.getElementById('form-email-confirm').value = correo;
                
                // Actualizar formulario de eliminaci√≥n
                document.getElementById('eliminar-user-id').value = documento;
                document.getElementById('eliminar-email').value = correo;
                document.getElementById('eliminar-nombre').value = nombreCompleto;
                
                // Actualizar formulario de logout
                document.getElementById('logout_user_id').value = documento;
                document.getElementById('logout_email').value = correo;
                
                return;
            }
            
            // Si no hay usuarioActual, cargar desde API
            console.log('üîÑ Cargando datos desde API...');
            await cargarDatosDesdeAPI();
            
        } catch (error) {
            console.error('‚ùå Error al cargar datos:', error);
            alert('Error al cargar los datos del perfil. Por favor recarga la p√°gina.');
        }
    }
    
    // ==================== CARGAR DATOS DESDE API ====================
    async function cargarDatosDesdeAPI() {
        try {
            const response = await fetch('/api/usuario/perfil', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Error al obtener datos del usuario');
            }
            
            const data = await response.json();
            
            if (data.success && data.usuario) {
                usuarioActual = data.usuario;
                localStorage.setItem('usuario', JSON.stringify(usuarioActual));
                
                // Recargar datos con la nueva informaci√≥n
                cargarDatosUsuario();
            } else {
                throw new Error(data.message || 'Error en la respuesta del servidor');
            }
            
        } catch (error) {
            console.error('‚ùå Error al cargar desde API:', error);
            alert('Error de autenticaci√≥n. Por favor inicia sesi√≥n nuevamente.');
            localStorage.removeItem('token');
            localStorage.removeItem('usuario');
            window.location.href = '/login';
        }
    }
    
    // ==================== EVENT LISTENERS ====================
    function configurarEventListeners() {
        // Men√∫ de perfil
        configurarMenuPerfil();
        
        // Notificaciones
        configurarNotificaciones();
        
        // Formulario editar perfil
        document.getElementById('form-editar-perfil').addEventListener('submit', editarPerfil);
        
        // Formulario eliminar cuenta
        document.getElementById('form-eliminar-cuenta').addEventListener('submit', eliminarCuenta);
        
        // Modal eliminar cuenta
        const btnEliminarCuenta = document.getElementById('btn-eliminar-cuenta');
        const modalEliminar = document.getElementById('modal-eliminar-cuenta');
        const btnCancelarEliminar = document.getElementById('btn-cancelar-eliminar');
    
        btnEliminarCuenta.addEventListener('click', function() {
            modalEliminar.style.display = 'flex';
        });
        
        btnCancelarEliminar.addEventListener('click', function() {
            modalEliminar.style.display = 'none';
        });
        
        // Cerrar modal al hacer click fuera del contenido
        modalEliminar.addEventListener('click', function(e) {
            if (e.target === modalEliminar) modalEliminar.style.display = 'none';
        });
    }
    
    // ==================== CONFIGURACI√ìN DEL MEN√ö DE PERFIL ====================
    function configurarMenuPerfil() {
        const perfilBtn = document.getElementById('perfil-btn');
        const popoverMenu = document.getElementById('popover-menu');
    
        if (perfilBtn && popoverMenu) {
            perfilBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = popoverMenu.style.display === 'block';
                
                // Cerrar notificaciones si est√°n abiertas
                document.getElementById('notificaciones-popover').style.display = 'none';
                
                popoverMenu.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    const rect = perfilBtn.getBoundingClientRect();
                    popoverMenu.style.position = 'fixed';
                    popoverMenu.style.top = (rect.bottom + window.scrollY + 10) + 'px';
                    popoverMenu.style.left = (rect.left + window.scrollX - 100) + 'px';
                    popoverMenu.style.zIndex = '1000';
                }
            });
    
            // Configurar items del men√∫
            document.querySelectorAll('.popover-list li').forEach((li, idx) => {
                li.addEventListener('click', () => {
                    switch(idx) {
                        case 0: 
                            window.location.href = '/perfil';
                            break;
                        case 1: 
                            // Ya estamos en configuraci√≥n
                            break;
                        case 2: 
                            window.location.href = '/favoritos';
                            break;
                        case 3: 
                            window.location.href = '/ayuda';
                            break;
                    }
                    popoverMenu.style.display = 'none';
                });
            });
    
            // Cerrar men√∫ al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (popoverMenu && !popoverMenu.contains(e.target) && e.target !== perfilBtn) {
                    popoverMenu.style.display = 'none';
                }
            });
        }
    }
    
    // ==================== EDITAR PERFIL ====================
    async function editarPerfil(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('.profile-save-btn');
        
        const email = formData.get('email');
        const emailConfirm = formData.get('email_confirm');
        const passwordActual = formData.get('password_actual');
        const passwordNueva = formData.get('password_nueva');
        const passwordConfirm = formData.get('password_confirm');
        const programa = formData.get('programa');
        
        // Validaciones
        if (email !== emailConfirm) {
            alert('‚ùå Los correos electr√≥nicos no coinciden');
            return;
        }
        
        if (!validarEmail(email)) {
            alert('‚ùå Por favor ingresa un correo electr√≥nico v√°lido');
            return;
        }
        
        // Validar contrase√±a si se est√° intentando cambiar
        if (passwordNueva || passwordActual || passwordConfirm) {
            if (!passwordActual) {
                alert('‚ùå Para cambiar la contrase√±a, debes ingresar tu contrase√±a actual');
                return;
            }
            
            if (!passwordNueva) {
                alert('‚ùå Debes ingresar una nueva contrase√±a');
                return;
            }
            
            if (passwordNueva !== passwordConfirm) {
                alert('‚ùå Las contrase√±as no coinciden');
                return;
            }
            
            if (!validarPassword(passwordNueva)) {
                alert('‚ùå La contrase√±a debe tener al menos 8 caracteres, incluyendo una may√∫scula, una min√∫scula y un n√∫mero');
                return;
            }
        }
        
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        submitBtn.disabled = true;
        
        try {
            // Enviar datos en el formato correcto
            const datosActualizacion = {
                correo: email,
                programa: programa
            };
            
            // Solo incluir datos de contrase√±a si se est√°n cambiando
            if (passwordNueva) {
                datosActualizacion.password_actual = passwordActual;
                datosActualizacion.password_nueva = passwordNueva;
            }
            
            console.log('üì§ Actualizando perfil:', datosActualizacion);
            
            const response = await fetch('/api/usuario/editar', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(datosActualizacion)
            });
            
            const data = await response.json();
            console.log('üì• Respuesta del servidor:', data);
            
            if (data.success) {
                alert('‚úÖ Perfil actualizado exitosamente!');
                
                // Actualizar datos en localStorage
                if (usuarioActual) {
                    usuarioActual.email = email;
                    usuarioActual.correo = email;
                    usuarioActual.programa = programa;
                    localStorage.setItem('usuario', JSON.stringify(usuarioActual));
                }
                
                // Recargar datos
                cargarDatosUsuario();
                
            } else {
                throw new Error(data.message || 'Error al actualizar perfil');
            }
            
        } catch (error) {
            console.error('‚ùå Error al actualizar perfil:', error);
            alert('‚ùå Error al actualizar perfil: ' + error.message);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
    
    // ==================== ELIMINAR CUENTA ====================
    async function eliminarCuenta(e) {
        e.preventDefault();
        
        if (!confirm('‚ö†Ô∏è ¬øEST√ÅS ABSOLUTAMENTE SEGURO/A?\n\nEsta acci√≥n eliminar√° permanentemente tu cuenta y todos tus datos.\nNO podr√°s recuperar tu cuenta despu√©s de esto.')) {
            return;
        }
        
        const submitBtn = document.querySelector('#btn-confirmar-eliminar');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
        submitBtn.disabled = true;
        
        try {
            console.log('üóëÔ∏è Intentando eliminar cuenta...');
            
            // SOLO enviar confirmaci√≥n - el backend obtiene el usuario del token
            const response = await fetch('/api/usuario/eliminar', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    confirmacion: true
                })
            });
            
            const data = await response.json();
            console.log('üì• Respuesta del servidor:', data);
            
            if (data.success) {
                alert('‚úÖ Cuenta eliminada exitosamente');
                
                // Limpiar localStorage y redirigir al login
                localStorage.removeItem('token');
                localStorage.removeItem('usuario');
                window.location.href = '/login';
                
            } else {
                throw new Error(data.message || 'Error al eliminar cuenta');
            }
            
        } catch (error) {
            console.error('‚ùå Error al eliminar cuenta:', error);
            alert('‚ùå Error al eliminar cuenta: ' + error.message);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            document.getElementById('modal-eliminar-cuenta').style.display = 'none';
        }
    }
    
    // ==================== FUNCIONES DE VALIDACI√ìN ====================
    function validarEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }
    
    function validarPassword(password) {
        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
        return regex.test(password);
    }
    
    // ==================== NOTIFICACIONES ====================
    function configurarNotificaciones() {
        const notiBtn = document.getElementById('notificaciones-btn');
        const notiPopover = document.getElementById('notificaciones-popover');
        
        if (notiBtn && notiPopover) {
            notiBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = notiPopover.style.display === 'block';
                
                // Cerrar men√∫ de perfil si est√° abierto
                document.getElementById('popover-menu').style.display = 'none';
                
                notiPopover.style.display = isVisible ? 'none' : 'block';
            });
        }
        
        document.addEventListener('click', function(e) {
            if (notiPopover && !notiPopover.contains(e.target) && e.target !== notiBtn) {
                notiPopover.style.display = 'none';
            }
        });
    }
    
    // ==================== CERRAR SESI√ìN ====================
    document.getElementById('logoutForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
            localStorage.removeItem('token');
            localStorage.removeItem('usuario');
            window.location.href = '/login';
        }
    });
    
    // ==================== MANEJO DE ERRORES GLOBAL ====================
    window.addEventListener('error', function(e) {
        console.error('Error global:', e.error);
    });
    
    // ==================== REDIRECCI√ìN DEL LOGO ====================
document.addEventListener('DOMContentLoaded', function() {
  const logoHeader = document.querySelector('.logo-header');
  if (logoHeader) {
    logoHeader.style.cursor = 'pointer';
    logoHeader.addEventListener('click', function() {
      console.log('üè† Redirigiendo a publicaciones');
      window.location.href = '/publicaciones';
    });
  }
});


    window.addEventListener('unhandledrejection', function(e) {
        console.error('Promise rechazada:', e.reason);
    });
</script>
</body>
</html>