<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIP - Detalles del Proyecto</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="/Detalles_Proyectos.css">
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <header class="header">
      <img src="/img/logo.png" alt="SIP Logo" class="logo-header">
      <nav class="nav-header">
        <a href="/feed-proyectos"><i class="fa-solid fa-layer-group"></i> Proyectos</a>
        <a href="#" id="notificaciones-btn"><i class="fa-regular fa-bell"></i> Notificaciones</a>
        <div class="user-info" id="perfil-btn">
          <span class="user-avatar">D</span>
          <span class="user-name">Daniela</span>
        </div>
      </nav>
      <!-- Notificaciones Popover -->
      <div id="notificaciones-popover" class="notificaciones-popover">
        <div class="notificaciones-arrow"></div>
        <h3>Notificaciones</h3>
        <div class="notificacion-item">
          <span class="notif-avatar">A</span>
          <div>
            <strong>Respondió tu publicación</strong>
            <div class="notif-text">Te dare varias ideas para tu proyecto...</div>
          </div>
        </div>
        <div class="notificacion-item">
          <span class="notif-avatar">J</span>
          <div>
            <strong>Respondió tu publicación</strong>
            <div class="notif-text">Te dare varias ideas para tu proyecto...</div>
          </div>
        </div>
        <div class="notificacion-item">
          <span class="notif-avatar">D</span>
          <div>
            <strong>Respondió tu respuesta</strong>
            <div class="notif-text">Muchas gracias me sirvió mucho, sig...</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Menú Popover de Usuario -->
    <div id="popover-menu" class="popover-menu">
      <div class="popover-arrow"></div>
      <div class="popover-content">
        <ul class="popover-list">
          <li>
            <span class="icon">
              <i class="fa-regular fa-user"></i>
            </span>
            <span>Perfil</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-solid fa-gear"></i>
            </span>
            <span>Configuración</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-regular fa-star"></i>
            </span>
            <span>Favoritos</span>
          </li>
          <li>
            <span class="icon">
              <i class="fa-regular fa-circle-question"></i>
            </span>
            <span>Ayuda</span>
          </li>
        </ul>
        <button class="logout-btn" id="logoutBtn">Cerrar sesión</button>
      </div>
    </div>

    <main class="detalle-main">
      <!-- Información principal del proyecto -->
      <section class="detalle-proyecto-card">
        <div class="detalle-img">
          <img id="imagen-principal" src="/img/placeholder-proyecto.png" alt="Imagen del proyecto">
        </div>
        <div class="detalle-info">
          <h2 class="detalle-titulo" id="proyecto-titulo">Cargando proyecto...</h2>
          <div class="detalle-autor" id="proyecto-autor">Cargando autor...</div>
          <div class="detalle-desc" id="proyecto-descripcion">
            Cargando descripción del proyecto...
          </div>
          <div class="detalle-meta">
            <div class="meta-item">
              <i class="fas fa-graduation-cap"></i>
              <span id="proyecto-programa">Cargando programa...</span>
            </div>
            <div class="meta-item">
              <i class="fab fa-github"></i>
              <span id="proyecto-github">GitHub no disponible</span>
            </div>
            <div class="meta-item">
              <i class="far fa-calendar"></i>
              <span id="proyecto-fecha">Cargando fecha...</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Galería de imágenes -->
      <section class="detalle-galeria" id="galeria-proyecto">
        <h3>Galería del Proyecto</h3>
        <div class="galeria-contenedor" id="galeria-contenedor">
          <!-- Las imágenes se cargarán dinámicamente aquí -->
        </div>
      </section>

      <!-- Documentación PDF -->
      <section class="detalle-documentacion" id="seccion-documentacion" style="display: none;">
        <h3>Documentación</h3>
        <div class="documento-item">
          <i class="far fa-file-pdf"></i>
          <a id="enlace-pdf" href="#" target="_blank">Ver documentación PDF</a>
        </div>
      </section>

      <!-- Comentarios -->
      <section class="detalle-comentarios">
        <h3>Comentarios</h3>
        
        <!-- Formulario para nuevo comentario -->
        <div class="nuevo-comentario">
          <textarea id="texto-comentario" placeholder="Escribe tu comentario... (máximo 100 caracteres)"></textarea>
          <div class="contador-caracteres">
            <span id="contador">0</span>/100 caracteres
          </div>
          <button id="btn-publicar-comentario" class="btn-comentar">Publicar comentario</button>
        </div>

        <!-- Lista de comentarios -->
        <div id="lista-comentarios">
          <!-- Los comentarios se cargarán dinámicamente aquí -->
        </div>
      </section>
    </main>

    <!-- Modal Editar Comentario -->
    <div id="modal-editar-comentario" class="modal-publicacion" style="display:none;">
      <div class="modal-content">
        <h2>Editar Comentario</h2>
        <form id="form-editar-comentario">
          <input type="hidden" id="edit_comentario_id">
          <textarea id="editar-comentario-texto" placeholder="Escribe tu comentario..." maxlength="100"></textarea>
          <div class="contador-caracteres">
            <span id="edit-contador">0</span>/100 caracteres
          </div>
          <div class="modal-btns">
            <button type="submit" id="btn-editar-comentario-publicar" class="btn-modal">Actualizar</button>
            <button type="button" id="btn-editar-comentario-cancelar" class="btn-modal cancelar">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Reportar Comentario -->
    <div id="modal-reportar-comentario" class="modal-publicacion" style="display:none;">
      <div class="modal-content">
        <h2 style="color:#184C3A; font-size:1.3em; text-align:center; margin-bottom:18px;">Motivo de su reporte</h2>
        <select id="motivo-reporte" style="width:100%; border:1.5px solid #184C3A; border-radius:8px; padding:8px; margin-bottom:18px; font-size:1em; color:#184C3A; background:#f8fbfa;">
          <option value="" disabled selected>Seleccione su motivo...</option>
          <option value="spam">Spam</option>
          <option value="ofensivo">Contenido ofensivo</option>
          <option value="fuera-tema">Fuera de tema</option>
          <option value="otro">Otro</option>
        </select>
        <div class="modal-btns">
          <button id="btn-reportar-comentario" class="btn-modal reportar-btn">Reportar</button>
          <button id="btn-cancelar-reporte" class="btn-modal cancelar">Cancelar</button>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <hr class="footer-line">
        <div class="footer-icons">
          <i class="fab fa-twitter"></i>
          <i class="fab fa-facebook"></i>
          <i class="fab fa-instagram"></i>
        </div>
        <hr class="footer-line">
      </div>
      <div class="footer-text">
        Copyright © 2025 SENA INTERACTIVE PORTAL
      </div>
      <div class="footer-links">
        <span>Información legal</span>
        <span>Política de privacidad</span>
      </div>
    </footer>
  </div>

  <script>
    // ===== CARGAR DATOS DEL PROYECTO =====
    async function cargarDetallesProyecto() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const proyectoId = urlParams.get('id');
        
        if (!proyectoId) {
          console.error('No se proporcionó ID de proyecto');
          mostrarProyectoEjemplo();
          return;
        }

        console.log('Cargando detalles del proyecto:', proyectoId);
        
        const response = await fetch(`/api/proyectos/${proyectoId}`);
        
        if (!response.ok) {
          throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Datos del proyecto:', data);
        
        if (data.success && data.proyecto) {
          mostrarDetallesProyecto(data.proyecto);
        } else {
          throw new Error(data.message || 'Error al cargar proyecto');
        }
        
      } catch (error) {
        console.error('Error al cargar detalles:', error);
        mostrarProyectoEjemplo();
      }
    }

    function mostrarDetallesProyecto(proyecto) {
      // Información básica
      document.getElementById('proyecto-titulo').textContent = proyecto.nombre || 'Sin título';
      document.getElementById('proyecto-autor').textContent = 
        proyecto.autor_completo || 
        (proyecto.nombre_autor + ' ' + proyecto.apellido_autor) || 
        'Autor no disponible';
      document.getElementById('proyecto-descripcion').textContent = 
        proyecto.descripcion || 'Sin descripción disponible';
      document.getElementById('proyecto-programa').textContent = 
        proyecto.programa_autor || 'Programa no disponible';
      document.getElementById('proyecto-fecha').textContent = 
        formatearFecha(proyecto.fecha_creacion) || 'Fecha no disponible';

      // GitHub
      const githubElement = document.getElementById('proyecto-github');
      if (proyecto.github_url) {
        githubElement.innerHTML = `<a href="${proyecto.github_url}" target="_blank">Ver código en GitHub</a>`;
      } else {
        githubElement.textContent = 'GitHub no disponible';
      }

      // Imágenes
      cargarImagenesProyecto(proyecto);

      // PDF
      cargarDocumentacionPDF(proyecto);

      // Comentarios
      cargarComentariosProyecto(proyecto);
    }

    function cargarImagenesProyecto(proyecto) {
      const imagenPrincipal = document.getElementById('imagen-principal');
      const galeriaContenedor = document.getElementById('galeria-contenedor');
      
      galeriaContenedor.innerHTML = '';

      // Manejar diferentes formatos de imágenes
      let imagenes = [];

      // Caso 1: Array de imágenes directo
      if (proyecto.imagenes && Array.isArray(proyecto.imagenes)) {
        imagenes = proyecto.imagenes;
      }
      // Caso 2: Imágenes desde relación imagen_proyecto
      else if (proyecto.imagen_proyecto && Array.isArray(proyecto.imagen_proyecto)) {
        imagenes = proyecto.imagen_proyecto.map(img => img.ruta_imagen || img.url);
      }
      // Caso 3: Imagen individual
      else if (proyecto.ruta_imagen || proyecto.imagen_principal) {
        imagenes = [proyecto.ruta_imagen || proyecto.imagen_principal];
      }

      console.log('Imágenes a mostrar:', imagenes);

      if (imagenes.length > 0) {
        // Usar primera imagen como principal
        const primeraImagen = imagenes[0];
        imagenPrincipal.src = primeraImagen.startsWith('/') ? primeraImagen : `/uploads/${primeraImagen}`;
        imagenPrincipal.alt = proyecto.nombre || 'Imagen del proyecto';

        // Crear galería con todas las imágenes
        imagenes.forEach((imagen, index) => {
          const imgElement = document.createElement('div');
          imgElement.className = 'galeria-img';
          const rutaCompleta = imagen.startsWith('/') ? imagen : `/uploads/${imagen}`;
          imgElement.innerHTML = `
            <img src="${rutaCompleta}" 
                 alt="Imagen ${index + 1} del proyecto ${proyecto.nombre}" 
                 onclick="cambiarImagenPrincipal('${rutaCompleta}')">
          `;
          galeriaContenedor.appendChild(imgElement);
        });
      } else {
        // Si no hay imágenes, usar placeholder
        imagenPrincipal.src = '/img/placeholder-proyecto.png';
        imagenPrincipal.alt = 'Imagen no disponible';
        
        // Crear 4 placeholders para la galería
        for (let i = 0; i < 4; i++) {
          const imgElement = document.createElement('div');
          imgElement.className = 'galeria-img';
          imgElement.innerHTML = `
            <img src="/img/placeholder-proyecto.png" 
                 alt="Imagen no disponible"
                 onclick="cambiarImagenPrincipal('/img/placeholder-proyecto.png')">
          `;
          galeriaContenedor.appendChild(imgElement);
        }
      }
    }

    function cargarDocumentacionPDF(proyecto) {
      const seccionDocumentacion = document.getElementById('seccion-documentacion');
      const enlacePDF = document.getElementById('enlace-pdf');
      
      if (proyecto.documento_pdf) {
        seccionDocumentacion.style.display = 'block';
        const rutaPDF = proyecto.documento_pdf.startsWith('/') ? proyecto.documento_pdf : `/uploads/${proyecto.documento_pdf}`;
        enlacePDF.href = rutaPDF;
        enlacePDF.textContent = 'Descargar documentación PDF';
      } else {
        seccionDocumentacion.style.display = 'none';
      }
    }

    // ===== FUNCIÓN CARGAR COMENTARIOS PARA DETALLES =====
    async function cargarComentariosProyecto(proyecto) {
        try {
            const proyectoId = proyecto.ID_proyecto;
            const user_id = 16; // Cambiar por el ID del usuario logueado
            
            const response = await fetch(`/api/proyectos/${proyectoId}/comentarios?user_id=${user_id}`);
            const data = await response.json();
            
            const listaComentarios = document.getElementById('lista-comentarios');
            
            if (data.success && data.comentarios && data.comentarios.length > 0) {
                listaComentarios.innerHTML = data.comentarios.map(comentario => `
                    <div class="comentario-item" id="comentario-${comentario.ID_comentario}">
                        <div class="comentario-header">
                            <div class="comentario-info">
                                <span class="comentario-autor">${comentario.nombre || 'Usuario'} ${comentario.apellido || ''}</span>
                                <span class="comentario-fecha">${formatearFecha(comentario.fecha_creacion)}</span>
                            </div>
                            
                            <!-- Menú de 3 puntos para comentarios -->
                            ${comentario.es_autor ? `
                            <div class="comentario-acciones">
                                <button class="menu-tres-puntos" onclick="toggleComentarioMenu(${comentario.ID_comentario}, event)">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                
                                <div class="menu-desplegable" id="menu-comentario-${comentario.ID_comentario}">
                                    <button class="menu-item editar" onclick="editarComentario(${comentario.ID_comentario})">
                                        <i class="fas fa-edit"></i>
                                        Editar
                                    </button>
                                    <button class="menu-item eliminar" onclick="eliminarComentario(${comentario.ID_comentario})">
                                        <i class="fas fa-trash"></i>
                                        Eliminar
                                    </button>
                                </div>
                            </div>
                            ` : `
                            <div class="comentario-acciones">
                                <button class="menu-tres-puntos" onclick="mostrarReportarComentarioModal(${comentario.ID_comentario})">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                            `}
                        </div>
                        
                        <div class="comentario-contenido" id="texto-comentario-${comentario.ID_comentario}">
                            ${comentario.contenido}
                        </div>
                    </div>
                `).join('');
            } else {
                listaComentarios.innerHTML = `
                    <div class="sin-comentarios">
                        <i class="far fa-comments"></i>
                        <p>No hay comentarios aún</p>
                        <small>Sé el primero en comentar</small>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error al cargar comentarios:', error);
            document.getElementById('lista-comentarios').innerHTML = `
                <div class="error-comentarios">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error al cargar comentarios</p>
                </div>
            `;
        }
    }

    // ===== FUNCIONES PARA COMENTARIOS (ESTILO PROYECTOS) =====
    let menuComentarioAbierto = null;

    function toggleComentarioMenu(comentarioId, event) {
      event.stopPropagation();
      const menu = document.getElementById(`menu-comentario-${comentarioId}`);
      
      // Cerrar menú anterior si hay uno abierto
      if (menuComentarioAbierto && menuComentarioAbierto !== menu) {
        menuComentarioAbierto.classList.remove('mostrar');
      }
      
      // Alternar el menú actual
      menu.classList.toggle('mostrar');
      menuComentarioAbierto = menu.classList.contains('mostrar') ? menu : null;
    }

    // Cerrar menú al hacer clic fuera de él
    document.addEventListener('click', function(e) {
      if (menuComentarioAbierto && !e.target.closest('.comentario-acciones')) {
        menuComentarioAbierto.classList.remove('mostrar');
        menuComentarioAbierto = null;
      }
    });

    // Función para editar comentario
    function editarComentario(comentarioId) {
      const comentarioTexto = document.getElementById(`texto-comentario-${comentarioId}`).innerText;
      
      document.getElementById('edit_comentario_id').value = comentarioId;
      document.getElementById('editar-comentario-texto').value = comentarioTexto;
      document.getElementById('edit-contador').textContent = comentarioTexto.length;
      
      // Mostrar modal de edición
      document.getElementById('modal-editar-comentario').style.display = 'flex';
      
      // Cerrar menú
      if (menuComentarioAbierto) {
        menuComentarioAbierto.classList.remove('mostrar');
        menuComentarioAbierto = null;
      }
    }

    // Función para eliminar comentario
    async function eliminarComentario(comentarioId) {
      if (!confirm('¿Estás seguro de que quieres eliminar este comentario?\nEsta acción no se puede deshacer.')) {
        return;
      }

      try {
        const user_id = 16; // Cambiar por el ID del usuario logueado
        
        const response = await fetch(`/api/comentarios/${comentarioId}/eliminar`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ user_id })
        });

        const data = await response.json();

        if (data.success) {
          alert('✅ Comentario eliminado exitosamente');
          // Recargar los comentarios
          const proyectoId = new URLSearchParams(window.location.search).get('id');
          cargarDetallesProyecto();
        } else {
          alert('❌ Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al eliminar comentario');
      }
      
      // Cerrar menú
      if (menuComentarioAbierto) {
        menuComentarioAbierto.classList.remove('mostrar');
        menuComentarioAbierto = null;
      }
    }

    // Manejar envío del formulario de edición de comentario
    document.getElementById('form-editar-comentario').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const comentarioId = document.getElementById('edit_comentario_id').value;
      const nuevoTexto = document.getElementById('editar-comentario-texto').value.trim();
      const submitBtn = document.getElementById('btn-editar-comentario-publicar');
      
      if (!nuevoTexto) {
        alert('Por favor escribe un comentario');
        return;
      }
      
      if (nuevoTexto.length > 100) {
        alert('❌ El comentario no puede tener más de 100 caracteres');
        return;
      }

      // Mostrar loading
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
      submitBtn.disabled = true;
      
      try {
        const user_id = 16; // Cambiar por el ID del usuario logueado
        
        const response = await fetch(`/api/comentarios/${comentarioId}/editar`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            },
          body: JSON.stringify({ 
            contenido: nuevoTexto,
            user_id: user_id
          })
        });
        
        const data = await response.json();
        console.log('Respuesta del servidor:', data);
        
        if (data.success) {
          alert('✅ Comentario actualizado exitosamente!');
          
          // Cerrar modal
          document.getElementById('modal-editar-comentario').style.display = 'none';
          
          // Recargar comentarios
          cargarDetallesProyecto();
        } else {
          throw new Error(data.message || 'Error al actualizar comentario');
        }
        
      } catch (error) {
        console.error('Error al actualizar comentario:', error);
        alert('❌ Error al actualizar comentario: ' + error.message);
      } finally {
        // Restaurar botón
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Contador de caracteres para editar comentario
    document.getElementById('editar-comentario-texto').addEventListener('input', function() {
      const texto = this.value;
      const contador = document.getElementById('edit-contador');
      contador.textContent = texto.length;
      
      if (texto.length > 100) {
        contador.style.color = '#e53e3e';
        contador.style.fontWeight = 'bold';
      } else {
        contador.style.color = '#666';
        contador.style.fontWeight = 'normal';
      }
    });

    // Cerrar modal de edición de comentario
    document.getElementById('btn-editar-comentario-cancelar').onclick = function() {
      document.getElementById('modal-editar-comentario').style.display = 'none';
    };

    document.getElementById('modal-editar-comentario').addEventListener('click', function(e) {
      if (e.target === this) this.style.display = 'none';
    });

    // Función para cambiar la imagen principal
    function cambiarImagenPrincipal(src) {
      document.getElementById('imagen-principal').src = src;
    }

    // Función para formatear fecha CON HORA EXACTA
// Función para formatear fecha con hora actualizada y formato relativo
function formatearFecha(fechaString) {
  try {
    // Si es una fecha reciente (menos de 24 horas), mostrar tiempo relativo
    const fecha = new Date(fechaString);
    const ahora = new Date();
    const diferencia = ahora - fecha;
    const diferenciaMinutos = Math.floor(diferencia / (1000 * 60));
    const diferenciaHoras = Math.floor(diferencia / (1000 * 60 * 60));
    
    // Si es hace menos de 1 minuto
    if (diferenciaMinutos < 1) {
      return 'Ahora mismo';
    }
    // Si es hace menos de 1 hora
    else if (diferenciaMinutos < 60) {
      return `Hace ${diferenciaMinutos} minuto${diferenciaMinutos > 1 ? 's' : ''}`;
    }
    // Si es hace menos de 24 horas
    else if (diferenciaHoras < 24) {
      return `Hace ${diferenciaHoras} hora${diferenciaHoras > 1 ? 's' : ''}`;
    }
    // Si es de hoy
    else if (fecha.toDateString() === ahora.toDateString()) {
      return `Hoy a las ${fecha.toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit' 
      })}`;
    }
    // Si es de ayer
    else if (fecha.toDateString() === new Date(ahora - 86400000).toDateString()) {
      return `Ayer a las ${fecha.toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit' 
      })}`;
    }
    // Para fechas más antiguas
    else {
      return fecha.toLocaleString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
  } catch (error) {
    console.error('Error formateando fecha:', error);
    return 'Fecha no disponible';
  }
}

    // Función para mostrar proyecto de ejemplo si hay error
    function mostrarProyectoEjemplo() {
      document.getElementById('proyecto-titulo').textContent = 'Proyecto de Ejemplo';
      document.getElementById('proyecto-autor').textContent = 'Usuario Ejemplo';
      document.getElementById('proyecto-descripcion').textContent = 'No se pudo cargar la información del proyecto.';
      document.getElementById('proyecto-programa').textContent = 'Programa no disponible';
    }

    // ===== FUNCIONALIDADES EXISTENTES =====

    // Menú de notificaciones popover
    const notiBtn = document.getElementById('notificaciones-btn');
    const notiPopover = document.getElementById('notificaciones-popover');
    notiBtn.onclick = function(e) {
      e.stopPropagation();
      notiPopover.style.display = notiPopover.style.display === 'block' ? 'none' : 'block';
    };
    notiPopover.onclick = function(e) {
      e.stopPropagation();
    };
    document.addEventListener('click', function(e) {
      if (!notiPopover.contains(e.target) && e.target !== notiBtn) {
        notiPopover.style.display = 'none';
      }
    });
    
    // Menú Popover Usuario
    const perfilBtn = document.getElementById('perfil-btn');
    const popoverMenu = document.getElementById('popover-menu');
    perfilBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (popoverMenu.style.display === 'block') {
        popoverMenu.style.display = 'none';
      } else {
        const rect = perfilBtn.getBoundingClientRect();
        popoverMenu.style.display = 'block';
        popoverMenu.style.position = 'absolute';
        popoverMenu.style.top = (rect.bottom + window.scrollY + 10) + 'px';
        popoverMenu.style.left = (rect.left + rect.width/2 - 160) + 'px';
      }
    });
    document.addEventListener('click', function(e) {
      if (!popoverMenu.contains(e.target) && e.target !== perfilBtn) {
        popoverMenu.style.display = 'none';
      }
    });

    // Botón cerrar sesión
    document.getElementById('logoutBtn').addEventListener('click', function() {
      alert('Sesión cerrada.');
      popoverMenu.style.display = 'none';
    });

    // Opciones del menú
    document.querySelectorAll('.popover-list li').forEach((li, idx) => {
      li.addEventListener('click', () => {
        switch(idx) {
          case 0: alert('Ir al Perfil'); break;
          case 1: alert('Ir a Configuración'); break;
          case 2: alert('Ir a Favoritos'); break;
          case 3: alert('Ir a Ayuda'); break;
        }
        popoverMenu.style.display = 'none';
      });
    });

    // Mostrar modal de reporte
    function mostrarReportarComentarioModal(comentarioId) {
      document.getElementById('modal-reportar-comentario').style.display = 'flex';
      // Aquí puedes guardar el comentarioId para usarlo al reportar
      document.getElementById('modal-reportar-comentario').dataset.comentarioId = comentarioId;
    }

    // Cerrar modal de reporte
    document.getElementById('btn-cancelar-reporte').onclick = function() {
      document.getElementById('modal-reportar-comentario').style.display = 'none';
    };

    // ===== CONTADOR DE CARACTERES PARA COMENTARIOS =====
    document.getElementById('texto-comentario').addEventListener('input', function() {
      const texto = this.value;
      const contador = document.getElementById('contador');
      contador.textContent = texto.length;
      
      if (texto.length > 100) {
        contador.style.color = '#e53e3e';
        contador.style.fontWeight = 'bold';
      } else {
        contador.style.color = '#666';
        contador.style.fontWeight = 'normal';
      }
    });

    // Publicar nuevo comentario - VERSIÓN MEJORADA
    document.getElementById('btn-publicar-comentario').addEventListener('click', async function() {
      const texto = document.getElementById('texto-comentario').value.trim();
      
      // VALIDAR LONGITUD MÁXIMA (100 caracteres)
      if (texto.length > 100) {
        alert('❌ El comentario no puede tener más de 100 caracteres');
        return;
      }
      
      if (!texto) {
        alert('Por favor escribe un comentario');
        return;
      }

      try {
        const proyectoId = new URLSearchParams(window.location.search).get('id');
        console.log('Enviando comentario...', { proyectoId, texto });
        
        const response = await fetch(`/api/proyectos/${proyectoId}/comentarios`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contenido: texto,
            user_id: 16 // Esto debería venir de la sesión
          })
        });

        const data = await response.json();
        console.log('Respuesta del servidor:', data);
        
        if (data.success) {
          document.getElementById('texto-comentario').value = '';
          document.getElementById('contador').textContent = '0';
          document.getElementById('contador').style.color = '#666';
          alert('✅ Comentario publicado exitosamente');
          cargarDetallesProyecto(); // Recargar para mostrar el nuevo comentario
        } else {
          alert('❌ Error al publicar comentario: ' + data.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('❌ Error de conexión al publicar comentario');
      }
    });

    // ===== INICIALIZAR =====
    document.addEventListener('DOMContentLoaded', function() {
      cargarDetallesProyecto();
    });
  </script>
</body>
</html>