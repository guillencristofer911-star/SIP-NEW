<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIP - Favoritos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="/Public/Favoritos.css">
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <header class="header">
      <img src="../html/css/img/logo copy.png" alt="SIP Logo" class="logo-header">
      <nav class="nav-header">
        <a href="#"><i class="fa-solid fa-layer-group"></i> Proyectos</a>
        <a href="#" id="notificaciones-btn"><i class="fa-regular fa-bell"></i> Notificaciones</a>
        <div class="user-info" id="perfil-btn">
          <span class="user-avatar">D</span>
          <span class="user-name">Daniela</span>
        </div>
      </nav>
    </header>

    <div class="favoritos-layout">
      <div class="favoritos-tabs-slider favoritos-tabs-top">
        <input type="radio" id="tab-publicaciones" name="favoritos-tab" checked>
        <input type="radio" id="tab-proyectos" name="favoritos-tab">
        <div class="favoritos-slider-bg"></div>
        <label for="tab-publicaciones" class="favoritos-tab-btn" onclick="mostrarTab('publicaciones')">Publicaciones</label>
        <label for="tab-proyectos" class="favoritos-tab-btn" onclick="mostrarTab('proyectos')">Proyectos</label>
      </div>

      <!-- Panel de filtros -->
      <aside class="filtros">
        <form class="filtros-form" id="filtrosForm" method="GET" action="/filtrar">
          <input type="text" id="input-busqueda" placeholder="Buscar por palabra clave...">
          <select id="filtro-programa" name="programa">
            <option value="">Todos los programas</option>
            <option value="desarrollo_software">Desarrollo de Software</option>
            <option value="diseno_grafico">Diseño Gráfico</option>
            <option value="administracion">Administración</option>
          </select>

          <input type="date" id="input-fecha" placeholder="dd/mm/aaaa">
          <!-- <button type="submit" class="btn-filtrar">Filtrar</button> -->
        </form>
        <button class="btn-limpiar" type="button" id="btnLimpiarFiltros">Limpiar Filtros</button>
      </aside>

      <!-- Contenido principal -->
      <main class="favoritos-main">
        <h2 class="favoritos-titulo">Mis Favoritos</h2>

        <!-- Lista publicaciones (tab Publicaciones) -->
        <div class="favoritos-lista" id="lista-publicaciones" style="display:flex; flex-direction:column; gap:16px;">
          <!-- Publicación 1 (note el data-fecha en ISO) -->
          <div class="proyecto-card" data-fecha="2025-08-15T14:30:00.000Z">
            <div class="proyecto-header">
              <span class="proyecto-titulo">¿Oportunidades de prácticas en empresa de software?</span>
              <span class="proyecto-fecha">15 agosto 2025, 02:30 pm</span>
              <form method="POST" action="/favorito" style="display: inline;">
                <input type="hidden" name="publicacion_id" value="1">
                <input type="hidden" name="accion" value="toggle">
                <button class="proyecto-fav" type="submit"><i class="fa-solid fa-star"></i></button>
              </form>
            </div>
            <div class="proyecto-autor">
              Ana Gomez
              <span class="proyecto-etiqueta egresado">Egresado</span>
            </div>
            <div class="proyecto-carrera">holahola</div>
            <div class="proyecto-desc">
              La empresa TechSolutions está buscando aprendices SENA para prácticas profesionales. Requisitos: conocimientos en Java y SQL.
            </div>
            <div class="proyecto-footer" style="display: flex; align-items: center; gap: 12px;">
              <span class="proyecto-comentarios" onclick="toggleComentarios(this, 'comentariosLista1')" style="cursor:pointer; font-weight:600;">5 Respuestas</span>
              <button class="btn-abrir btn-responder" type="button" data-publicacion="1" style="margin-left:auto;">Responder</button>
            </div>
            <div class="comentarios-lista" id="comentariosLista1" style="display:none;">
              <!-- comentarios... (sin cambios) -->
            </div>
          </div>

          <!-- Publicación 2 -->
          <div class="proyecto-card" data-fecha="2025-08-13T14:30:00.000Z">
            <div class="proyecto-header">
              <span class="proyecto-titulo">¿Oportunidades de prácticas en empresa de software?</span>
              <span class="proyecto-fecha">13 agosto 2025, 02:30 pm</span>
              <form method="POST" action="/favorito" style="display: inline;">
                <input type="hidden" name="publicacion_id" value="2">
                <input type="hidden" name="accion" value="toggle">
                <button class="proyecto-fav" type="submit"><i class="fa-solid fa-star"></i></button>
              </form>
            </div>
            <div class="proyecto-autor">Ana Gomez <span class="proyecto-etiqueta egresado">Egresado</span></div>
            <div class="proyecto-carrera">Tecnología en Desarrollo de Software</div>
            <div class="proyecto-desc">La empresa TechSolutions está buscando aprendices SENA para prácticas profesionales. Requisitos: conocimientos en Java y SQL.</div>
            <div class="proyecto-footer" style="display:flex; align-items:center; gap:12px;">
              <span class="proyecto-comentarios" onclick="toggleComentarios(this,'comentariosLista2')" style="cursor:pointer; font-weight:600;">No hay comentarios</span>
              <button class="btn-abrir btn-responder" type="button" data-publicacion="2" style="margin-left:auto;">Responder</button>
            </div>
            <div class="comentarios-lista" id="comentariosLista2" style="display:none;">
              <div class="comentario-vacio">No hay comentarios.</div>
            </div>
          </div>
        </div>

        <!-- Lista proyectos (tab Proyectos) -->
        <div class="favoritos-lista" id="lista-proyectos" style="display:none; flex-direction:column; gap:16px;">
          <div class="proyecto-card" data-fecha="2025-08-16T14:30:00.000Z">
            <div class="proyecto-header">
              <span class="proyecto-titulo">Menú Restaurante APP</span>
              <span class="proyecto-fecha">16 agosto 2025, 02:30 pm</span>
              <form method="POST" action="/favorito" style="display:inline;">
                <input type="hidden" name="proyecto_id" value="1">
                <input type="hidden" name="accion" value="toggle">
                <button class="proyecto-fav" type="submit"><i class="fa-solid fa-star"></i></button>
              </form>
            </div>
            <div class="proyecto-autor">Ana Gomez <span class="proyecto-etiqueta egresado">Egresado</span></div>
            <div class="proyecto-carrera">sure</div>
            <div class="proyecto-desc">App de menú para restaurante Amelia, va dirigido a los restaurantes que quieren tener mas visibilidad a lo que ofrecen a sus clientes</div>
            <div class="proyecto-footer" style="display:flex; align-items:center; gap:12px;">
              <form method="GET" action="/proyecto/1" style="margin-left:auto;">
                <button class="btn-abrir" type="submit">Abrir</button>
              </form>
            </div>
          </div>

          <div class="proyecto-card" data-fecha="2025-08-13T14:30:00.000Z">
            <div class="proyecto-header">
              <span class="proyecto-titulo">Menú Restaurante APP</span>
              <span class="proyecto-fecha">13 agosto 2025, 02:30 pm</span>
              <form method="POST" action="/favorito" style="display:inline;">
                <input type="hidden" name="proyecto_id" value="2">
                <input type="hidden" name="accion" value="toggle">
                <button class="proyecto-fav" type="submit"><i class="fa-solid fa-star"></i></button>
              </form>
            </div>
            <div class="proyecto-autor">Ana Gomez <span class="proyecto-etiqueta egresado">Egresado</span></div>
            <div class="proyecto-carrera">Tecnología en Desarrollo de Software</div>
            <div class="proyecto-desc">App de menú para restaurante Amelia, va dirigido a los restaurantes que quieren tener mas visibilidad a lo que ofrecen a sus clientes</div>
            <div class="proyecto-footer" style="display:flex; align-items:center; gap:12px;">
              <form method="GET" action="/proyecto/2" style="margin-left:auto;">
                <button class="btn-abrir" type="submit">Abrir</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Modal responder publicación -->
        <div id="modal-responder" class="modal-responder" style="display:none;">
          <div class="modal-responder-content">
            <div class="modal-responder-title">Responder publicación</div>
            <form class="modal-responder-publicacion" action="/responder" method="POST" id="form-respuesta">
              <input type="hidden" name="publicacion_id" id="publicacion_id" value="">
              <input type="hidden" name="usuario_id" value="1">
              <textarea class="modal-responder-textarea" name="descripcion_respuesta" placeholder="Ingrese la descripción..." required></textarea>
              <div class="modal-responder-btns">
                <button type="submit" id="btn-publicar-respuesta" class="btn-publicar">Publicar</button>
                <button type="button" id="btn-cancelar-respuesta" class="btn-cancelar">Cancelar</button>
              </div>
            </form>
          </div>
        </div>

      </main>
    </div> <!-- cierre layout -->

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <hr class="footer-line">
        <div class="footer-icons">
          <i class="fab fa-twitter"></i>
          <i class="fab fa-facebook"></i>
          <i class="fab fa-instagram"></i>
        </div>
        <hr class="footer-line">
      </div>
      <div class="footer-text">Copyright © 2025 SENA INTERACTIVE PORTAL</div>
      <div class="footer-links">
        <span>Información legal</span>
        <span>Política de privacidad</span>
      </div>
    </footer>
  </div>

  <!-- Menú Popover de Usuario -->
  <div id="popover-menu" class="popover-menu">
    <div class="popover-arrow"></div>
    <div class="popover-content">
      <ul class="popover-list">
        <li>
          <form method="GET" action="/perfil">
            <button type="submit" style="background: none; border: none; width: 100%; text-align: left; padding: 0;">
              <span class="icon"><i class="fa-regular fa-user"></i></span><span>Perfil</span>
            </button>
          </form>
        </li>
        <li>
          <form method="GET" action="/configuracion">
            <button type="submit" style="background: none; border: none; width: 100%; text-align: left; padding: 0;">
              <span class="icon"><i class="fa-solid fa-gear"></i></span><span>Configuración</span>
            </button>
          </form>
        </li>
        <li>
          <form method="GET" action="/favoritos">
            <button type="submit" style="background: none; border: none; width: 100%; text-align: left; padding: 0;">
              <span class="icon"><i class="fa-regular fa-star"></i></span><span>Favoritos</span>
            </button>
          </form>
        </li>
        <li>
          <form method="GET" action="/ayuda">
            <button type="submit" style="background: none; border: none; width: 100%; text-align: left; padding: 0;">
              <span class="icon"><i class="fa-regular fa-circle-question"></i></span><span>Ayuda</span>
            </button>
          </form>
        </li>
      </ul>
      <form method="POST" action="/logout">
        <button class="logout-btn" type="submit" id="logoutBtn">Cerrar sesión</button>
      </form>
    </div>
  </div>

  <!-- Popover de Notificaciones -->
  <div id="notificaciones-popover" class="notificaciones-popover" style="display:none;">
    <div class="notificaciones-content">
      <div class="notificaciones-titulo">Notificaciones</div>
      <!-- items... -->
    </div>
  </div>

  <script>
    // ===== MENÚ POPOVER USUARIO =====
    const perfilBtn = document.getElementById('perfil-btn');
    const popoverMenu = document.getElementById('popover-menu');

    perfilBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (popoverMenu.style.display === 'block') {
        popoverMenu.style.display = 'none';
      } else {
        const rect = perfilBtn.getBoundingClientRect();
        popoverMenu.style.display = 'block';
        popoverMenu.style.position = 'absolute';
        popoverMenu.style.top = (rect.bottom + window.scrollY + 10) + 'px';
        popoverMenu.style.left = (rect.left + rect.width/2 - 160) + 'px';
      }
    });

    document.addEventListener('click', function(e) {
      if (!popoverMenu.contains(e.target) && e.target !== perfilBtn) {
        popoverMenu.style.display = 'none';
      }
    });

    // Función para boton de publicados y proyectos
    function mostrarTab(tab) {
      document.getElementById('lista-publicaciones').style.display = (tab === 'publicaciones') ? 'flex' : 'none';
      document.getElementById('lista-proyectos').style.display = (tab === 'proyectos') ? 'flex' : 'none';
    }

    // Menú comentario
    window.toggleMenu = function(btn) {
      var menu = btn.nextElementSibling;
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    };
    // Mostrar/ocultar comentarios por publicación
    function toggleComentarios(btn, listaId) {
      var lista = document.getElementById(listaId);
      if (lista.style.display === 'none' || lista.style.display === '') {
        lista.style.display = 'block';
      } else {
        lista.style.display = 'none';
      }
    }

    // POPOVER NOTIFICACIONES
    const notificacionesBtn = document.getElementById('notificaciones-btn');
    const notificacionesPopover = document.getElementById('notificaciones-popover');

    notificacionesBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      popoverMenu.style.display = 'none';
      if (notificacionesPopover.style.display === 'block') {
        notificacionesPopover.style.display = 'none';
      } else {
        const rect = notificacionesBtn.getBoundingClientRect();
        notificacionesPopover.style.display = 'block';
        notificacionesPopover.style.top = (rect.bottom + window.scrollY + 10) + 'px';
        notificacionesPopover.style.left = (rect.left + rect.width/2 - 170) + 'px';
      }
    });

    document.addEventListener('click', function(e) {
      if (!notificacionesPopover.contains(e.target) && e.target !== notificacionesBtn) {
        notificacionesPopover.style.display = 'none';
      }
    });

    // Modal responder publicación
    const btnResponder = document.querySelectorAll('.btn-responder');
    const modalResponder = document.getElementById('modal-responder');
    const btnCancelarRespuesta = document.getElementById('btn-cancelar-respuesta');
    const formRespuesta = document.getElementById('form-respuesta');

    btnResponder.forEach(btn => {
      btn.addEventListener('click', () => {
        modalResponder.style.display = 'flex';
        const publicacionId = btn.getAttribute('data-publicacion');
        document.getElementById('publicacion_id').value = publicacionId;
      });
    });

    btnCancelarRespuesta.addEventListener('click', () => {
      modalResponder.style.display = 'none';
      formRespuesta.reset();
    });

    document.addEventListener('mousedown', function(e) {
      if (modalResponder.style.display === 'flex' && e.target === modalResponder) {
        modalResponder.style.display = 'none';
        formRespuesta.reset();
      }
    });

    formRespuesta.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      console.log('Datos enviados:', Object.fromEntries(formData));
      alert('Respuesta enviada! Ver datos en el inspector (consola)');
      modalResponder.style.display = 'none';
      this.reset();
    });

    // Interceptar envío del formulario de filtros (solo demo)
    document.getElementById('filtrosForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      console.log('Filtros aplicados:', Object.fromEntries(formData));
      alert('Filtros aplicados! Ver datos en el inspector (consola)');
    });

// ===============================
// ✅ FILTRADO FINAL CORREGIDO (para ambos tabs)
// ===============================
function filtrarPublicaciones() {
  const texto = (document.getElementById('input-busqueda').value || '').toLowerCase().trim();
  let fechaInput = (document.getElementById('input-fecha').value || '').trim();

  // Normalizar formatos escritos a mano (07 10 2025, 07/10/2025, etc)
  const numericDateMatch = fechaInput.match(/^(\d{1,2})[\/\s-](\d{1,2})[\/\s-](\d{4})$/);
  if (numericDateMatch) {
    const dia = numericDateMatch[1].padStart(2, "0");
    const mes = numericDateMatch[2].padStart(2, "0");
    const anio = numericDateMatch[3];
    fechaInput = `${anio}-${mes}-${dia}`;
  }

  // 🔍 Detectar qué tab está visible
  const tabVisible = document.getElementById("tab-publicaciones").checked
    ? document.getElementById("lista-publicaciones")
    : document.getElementById("lista-proyectos");

  // Recorrer solo las tarjetas del tab visible
  tabVisible.querySelectorAll(".proyecto-card").forEach(card => {
    const titulo = card.querySelector(".proyecto-titulo")?.innerText.toLowerCase() || "";
    const carrera = card.querySelector(".proyecto-carrera")?.innerText.toLowerCase() || "";
    const descripcion = card.querySelector(".proyecto-desc")?.innerText.toLowerCase() || "";

    // === FECHA DEL CARD ===
    let fechaCardYYYYMMDD = "";
    const dataFecha = card.getAttribute("data-fecha");

    if (dataFecha && dataFecha.includes("T")) {
      const dateObj = new Date(dataFecha);
      if (!isNaN(dateObj)) {
        const localY = dateObj.getFullYear();
        const localM = String(dateObj.getMonth() + 1).padStart(2, "0");
        const localD = String(dateObj.getDate()).padStart(2, "0");
        fechaCardYYYYMMDD = `${localY}-${localM}-${localD}`;
      }
    } else {
      // Si no hay data-fecha, intenta desde el texto visible
      const visible = card.querySelector(".proyecto-fecha")?.innerText || "";
      const match = visible.match(/(\d{1,2})[\/\s-](\d{1,2})[\/\s-](\d{4})/);
      if (match) fechaCardYYYYMMDD = `${match[3]}-${match[2].padStart(2,"0")}-${match[1].padStart(2,"0")}`;
    }

    // === FILTROS ===
    const coincideTexto =
      texto === "" ||
      titulo.includes(texto) ||
      carrera.includes(texto) ||
      descripcion.includes(texto);

    let coincideFecha = false;
    if (!fechaInput) {
      coincideFecha = true;
    } else if (!fechaCardYYYYMMDD) {
      coincideFecha = false;
    } else {
      const [fY, fM, fD] = fechaInput.split("-");
      const [cY, cM, cD] = fechaCardYYYYMMDD.split("-");
      coincideFecha =
        (!fY || fY === cY) &&
        (!fM || fM === cM) &&
        (!fD || fD === cD);
    }

    card.style.display = (coincideTexto && coincideFecha) ? "" : "none";
  });
}

// === EVENTOS ===
const inputTexto = document.getElementById("input-busqueda");
const inputFecha = document.getElementById("input-fecha");
const btnLimpiar = document.getElementById("btnLimpiarFiltros") || document.querySelector(".btn-limpiar");

if (inputTexto) inputTexto.addEventListener("input", filtrarPublicaciones);
if (inputFecha) {
  inputFecha.addEventListener("change", filtrarPublicaciones);
  inputFecha.addEventListener("input", filtrarPublicaciones);
}
if (btnLimpiar) {
  btnLimpiar.addEventListener("click", e => {
    e.preventDefault();
    if (inputTexto) inputTexto.value = "";
    if (inputFecha) inputFecha.value = "";
    filtrarPublicaciones();
  });
}

// ✅ Nuevo: cuando se cambia de tab (Publicaciones/Proyectos), volver a aplicar filtro
document.querySelectorAll('input[name="favoritos-tab"]').forEach(tab => {
  tab.addEventListener("change", filtrarPublicaciones);
});

// Ejecutar al cargar
document.addEventListener("DOMContentLoaded", filtrarPublicaciones);

  </script>
</body>
</html>
